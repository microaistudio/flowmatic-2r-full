<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowMatic Admin Panel</title>
    <style>
        /* FlowMatic Design System - Professional Light Theme */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #F8F9FA;
            color: #1F2937;
            min-height: 100vh;
        }

        /* LOGIN SCREEN */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #F8F9FA 0%, #FFFFFF 100%);
        }

        .login-card {
            background: #FFFFFF;
            padding: 48px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-header {
            margin-bottom: 32px;
        }

        .login-header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 8px;
        }

        .login-header p {
            font-size: 14px;
            color: #6B7280;
        }

        .form-group {
            margin-bottom: 24px;
            text-align: left;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            font-size: 14px;
            background: #FFFFFF;
            color: #1F2937;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #10B981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .login-button {
            width: 100%;
            padding: 12px 24px;
            background: #10B981;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .login-button:hover {
            background: #059669;
        }

        .login-button:disabled {
            background: #9CA3AF;
            cursor: not-allowed;
        }

        .error-message {
            background: #FEF2F2;
            color: #EF4444;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
            border: 1px solid #FECACA;
        }

        /* MAIN ADMIN LAYOUT */
        .admin-layout {
            display: none; /* Hidden until login */
            min-height: 100vh;
            background: #F8F9FA;
        }

        .admin-header {
            background: #FFFFFF;
            border-bottom: 1px solid #E5E7EB;
            padding: 0 32px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .admin-header h1 {
            font-size: 18px;
            font-weight: 600;
            color: #1F2937;
        }

        .admin-header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .admin-user {
            font-size: 14px;
            color: #6B7280;
        }

        .logout-button {
            padding: 8px 16px;
            background: transparent;
            color: #6B7280;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-button:hover {
            background: #F3F4F6;
            color: #374151;
        }

        .admin-content {
            display: flex;
            min-height: calc(100vh - 64px);
        }

        /* SIDEBAR NAVIGATION */
        .admin-sidebar {
            width: 256px;
            background: #F8F9FA;
            border-right: 1px solid #E5E7EB;
            padding: 24px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 24px;
            color: #6B7280;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-item:hover {
            background: #FFFFFF;
            color: #374151;
        }

        .nav-item.active {
            background: #FFFFFF;
            color: #10B981;
            border-right: 3px solid #10B981;
        }

        .nav-item-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            font-size: 16px;
        }

        /* MAIN CONTENT AREA */
        .admin-main {
            flex: 1;
            background: #FFFFFF;
            padding: 32px;
            overflow-y: auto;
        }

        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        .section-header {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 8px;
        }

        .section-description {
            font-size: 14px;
            color: #6B7280;
        }

        /* CARD COMPONENTS */
        .card {
            background: #FFFFFF;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: between;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #1F2937;
        }

        /* DASHBOARD COMPONENTS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: #FFFFFF;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #F3F4F6;
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-color);
        }

        .stat-card.green { --accent-color: #10B981; }
        .stat-card.orange { --accent-color: #F59E0B; }
        .stat-card.purple { --accent-color: #8B5CF6; }
        .stat-card.blue { --accent-color: #3B82F6; }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            flex-shrink: 0;
        }

        .stat-icon.green { background: #10B981; }
        .stat-icon.orange { background: #F59E0B; }
        .stat-icon.purple { background: #8B5CF6; }
        .stat-icon.blue { background: #3B82F6; }

        .stat-content {
            flex: 1;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #1F2937;
            line-height: 1;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            color: #6B7280;
            font-weight: 500;
        }

        .stat-trend {
            font-size: 12px;
            color: #059669;
            font-weight: 500;
            text-align: right;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .activity-card {
            min-height: 400px;
        }

        .queue-status-card {
            min-height: 400px;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #F3F4F6;
        }

        .refresh-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10B981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .refresh-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .refresh-btn:hover {
            background: #F3F4F6;
        }

        .activity-feed {
            max-height: 320px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #F9FAFB;
            font-size: 14px;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-time {
            color: #6B7280;
            font-weight: 500;
            min-width: 50px;
        }

        .activity-text {
            color: #374151;
            flex: 1;
        }

        .activity-item.loading {
            color: #9CA3AF;
            font-style: italic;
        }

        .queue-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .queue-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: #F9FAFB;
            border-radius: 8px;
            border: 1px solid #F3F4F6;
        }

        .service-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .service-badge.general { background: #10B981; }
        .service-badge.account { background: #F59E0B; }
        .service-badge.vip { background: #8B5CF6; }
        .service-badge.technical { background: #3B82F6; }

        .queue-count {
            font-size: 18px;
            font-weight: 600;
            color: #1F2937;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .action-btn.primary {
            background: #10B981;
            color: white;
        }

        .action-btn.primary:hover {
            background: #059669;
        }

        .action-btn.secondary {
            background: #F59E0B;
            color: white;
        }

        .action-btn.secondary:hover {
            background: #D97706;
        }

        .action-btn.info {
            background: #3B82F6;
            color: white;
        }

        .action-btn.info:hover {
            background: #2563EB;
        }

        .action-btn.warning {
            background: #EF4444;
            color: white;
        }

        .action-btn.warning:hover {
            background: #DC2626;
        }

        .action-btn.danger {
            background: #B91C1C;
            color: white;
        }

        .action-btn.danger:hover {
            background: #991B1B;
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .maintenance-card .card-header {
            border-bottom: 1px solid #F3F4F6;
        }

        .maintenance-grid {
            display: grid;
            grid-template-columns: minmax(0, 1fr) auto minmax(0, 1fr);
            gap: 24px;
            align-items: stretch;
            padding: 24px;
        }

        .maintenance-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .maintenance-title {
            font-size: 16px;
            font-weight: 600;
            color: #1F2937;
        }

        .maintenance-summary {
            font-size: 14px;
            font-weight: 500;
            color: #111827;
        }

        .maintenance-meta {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .maintenance-next,
        .maintenance-last {
            font-size: 13px;
            color: #6B7280;
        }

        .maintenance-status {
            font-size: 12px;
            color: #047857;
        }

        .maintenance-divider {
            width: 1px;
            background: #E5E7EB;
        }

        .preset-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .preset-row {
            display: grid;
            gap: 12px;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        }

        .preset-row label {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 13px;
            color: #4B5563;
        }

        .preset-row input,
        .preset-row select {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #D1D5DB;
            background: white;
            font-size: 14px;
            color: #1F2937;
        }

        .preset-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .preset-help {
            font-size: 12px;
            color: #6B7280;
        }

        @media (max-width: 900px) {
            .maintenance-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .maintenance-divider {
                display: none;
            }
        }

        .health-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .health-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #F9FAFB;
            border-radius: 8px;
            border: 1px solid #F3F4F6;
        }

        .health-label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .health-status {
            font-size: 12px;
        }

        .health-status.online {
            color: #10B981;
        }

        .health-status.offline {
            color: #EF4444;
        }

        .health-value {
            font-size: 14px;
            font-weight: 600;
            color: #1F2937;
        }

        /* SERVICES MANAGEMENT STYLES */
        .services-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .service-stat-card {
            background: #FFFFFF;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #F3F4F6;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .service-stat-content {
            flex: 1;
        }

        .service-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1F2937;
            line-height: 1;
            margin-bottom: 4px;
        }

        .service-stat-label {
            font-size: 12px;
            color: #6B7280;
            font-weight: 500;
        }

        .service-stat-icon {
            font-size: 24px;
            opacity: 0.7;
        }

        .services-header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 8px 16px;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            font-size: 14px;
            width: 200px;
            background: #FFFFFF;
        }

        .search-box input:focus {
            outline: none;
            border-color: #10B981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .services-table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #F3F4F6;
        }

        .services-table {
            width: 100%;
            border-collapse: collapse;
            background: #FFFFFF;
        }

        .services-table th {
            background: #F9FAFB;
            color: #374151;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #E5E7EB;
        }

        .services-table td {
            padding: 16px;
            border-bottom: 1px solid #F3F4F6;
            font-size: 14px;
            color: #374151;
        }

        .services-table tbody tr:hover {
            background: #F9FAFB;
        }

        .services-table tbody tr:last-child td {
            border-bottom: none;
        }

        .service-prefix {
            display: inline-block;
            padding: 4px 12px;
            background: #F3F4F6;
            border-radius: 12px;
            font-weight: 600;
            font-size: 12px;
            color: #374151;
        }

        .service-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .service-status.active {
            background: #D1FAE5;
            color: #065F46;
        }

        .service-status.inactive {
            background: #FEE2E2;
            color: #991B1B;
        }

        .service-actions {
            display: flex;
            gap: 8px;
        }

        .service-action-btn {
            padding: 6px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            background: transparent;
        }

        .service-action-btn:hover {
            background: #F3F4F6;
        }

        .service-action-btn.edit {
            color: #3B82F6;
        }

        .service-action-btn.delete {
            color: #EF4444;
        }

        .service-action-btn.toggle {
            color: #8B5CF6;
        }

        .loading-row td {
            text-align: center;
            color: #9CA3AF;
            font-style: italic;
            padding: 40px 16px;
        }

        .service-performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .performance-item {
            background: #F9FAFB;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #F3F4F6;
            text-align: center;
        }

        .performance-service-name {
            font-size: 16px;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 8px;
        }

        .performance-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            font-size: 12px;
            color: #6B7280;
        }

        .performance-loading {
            text-align: center;
            color: #9CA3AF;
            font-style: italic;
            padding: 40px;
            grid-column: 1 / -1;
        }

        /* MODAL STYLES */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.2s;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #FFFFFF;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s;
        }

        .modal-content.small {
            max-width: 400px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px 24px 16px;
            border-bottom: 1px solid #F3F4F6;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1F2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #9CA3AF;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #F3F4F6;
            color: #374151;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px 24px;
            border-top: 1px solid #F3F4F6;
        }

        /* FORM STYLES */
        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            font-size: 14px;
            background: #FFFFFF;
            color: #1F2937;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #10B981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .checkbox-label {
            display: flex !important;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            margin-bottom: 0 !important;
        }

        .checkbox-label input[type="checkbox"] {
            width: auto !important;
            margin: 0;
        }

        .checkmark {
            font-size: 14px;
            color: #374151;
        }

        .validation-messages {
            margin-top: 16px;
            padding: 12px;
            background: #FEF2F2;
            border: 1px solid #FECACA;
            border-radius: 6px;
            font-size: 14px;
            color: #DC2626;
            display: none;
        }

        .validation-messages.show {
            display: block;
        }

        .warning-text {
            color: #DC2626;
            font-size: 14px;
            margin-top: 8px;
        }

        /* AGENTS MANAGEMENT STYLES */
        .agents-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .agent-stat-card {
            background: #FFFFFF;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #F3F4F6;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .agent-stat-content {
            flex: 1;
        }

        .agent-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1F2937;
            line-height: 1;
            margin-bottom: 4px;
        }

        .agent-stat-label {
            font-size: 12px;
            color: #6B7280;
            font-weight: 500;
        }

        .agent-stat-icon {
            font-size: 24px;
            opacity: 0.7;
        }

        .online-count {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #6B7280;
        }

        .online-indicator {
            color: #10B981;
            font-size: 12px;
            animation: pulse 2s infinite;
        }

        .online-agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .online-agent-card {
            background: #F9FAFB;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #F3F4F6;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .agent-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #8B5CF6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .agent-info {
            flex: 1;
        }

        .agent-name {
            font-size: 14px;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 2px;
        }

        .agent-status {
            font-size: 12px;
            color: #6B7280;
        }

        .agent-services-badges {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }

        .agents-header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .agents-table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #F3F4F6;
        }

        .agents-table {
            width: 100%;
            border-collapse: collapse;
            background: #FFFFFF;
        }

        .agents-table th {
            background: #F9FAFB;
            color: #374151;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #E5E7EB;
        }

        .agents-table td {
            padding: 16px;
            border-bottom: 1px solid #F3F4F6;
            font-size: 14px;
            color: #374151;
            vertical-align: middle;
        }

        .agents-table tbody tr:hover {
            background: #F9FAFB;
        }

        .agents-table tbody tr:last-child td {
            border-bottom: none;
        }

        .agent-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .agent-cell .agent-avatar {
            width: 32px;
            height: 32px;
            font-size: 14px;
        }

        .agent-details {
            flex: 1;
        }

        .agent-details .agent-name {
            font-size: 14px;
            margin-bottom: 2px;
        }

        .agent-email {
            font-size: 12px;
            color: #9CA3AF;
        }

        .agent-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .agent-status-badge.online {
            background: #D1FAE5;
            color: #065F46;
        }

        .agent-status-badge.offline {
            background: #FEE2E2;
            color: #991B1B;
        }

        .agent-status-badge.break {
            background: #FEF3C7;
            color: #92400E;
        }

        .agent-services {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .agent-counter {
            padding: 4px 8px;
            background: #F3F4F6;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            color: #374151;
        }

        .agent-performance {
            text-align: center;
        }

        .performance-number {
            font-size: 16px;
            font-weight: 600;
            color: #10B981;
            display: block;
        }

        .performance-label {
            font-size: 11px;
            color: #6B7280;
        }

        .agent-role-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .agent-role-badge.agent {
            background: #E0E7FF;
            color: #3730A3;
        }

        .agent-role-badge.supervisor {
            background: #FEF3C7;
            color: #92400E;
        }

        .agent-role-badge.admin {
            background: #FEE2E2;
            color: #991B1B;
        }

        .agent-actions {
            display: flex;
            gap: 8px;
        }

        .agent-action-btn {
            padding: 6px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            background: transparent;
        }

        .agent-action-btn:hover {
            background: #F3F4F6;
        }

        .agent-action-btn.edit {
            color: #3B82F6;
        }

        .agent-action-btn.delete {
            color: #EF4444;
        }

        .agent-action-btn.reset {
            color: #8B5CF6;
        }

        .online-agent-loading {
            text-align: center;
            color: #9CA3AF;
            font-style: italic;
            padding: 40px;
            grid-column: 1 / -1;
        }

        .agent-performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .agent-performance-item {
            background: #F9FAFB;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #F3F4F6;
            text-align: center;
        }

        .performance-agent-name {
            font-size: 16px;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 12px;
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 12px;
        }

        .performance-metric {
            text-align: center;
        }

        .performance-metric-value {
            font-size: 18px;
            font-weight: 600;
            color: #10B981;
            display: block;
        }

        .performance-metric-label {
            font-size: 11px;
            color: #6B7280;
            margin-top: 2px;
        }

        /* FORM SECTIONS */
        .form-section {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid #F3F4F6;
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .form-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 8px;
        }

        .form-section-description {
            font-size: 14px;
            color: #6B7280;
            margin-bottom: 16px;
        }

        .form-help {
            display: block;
            font-size: 12px;
            color: #6B7280;
            margin-top: 4px;
        }

        /* SERVICE ASSIGNMENTS */
        .service-assignments {
            display: grid;
            gap: 12px;
        }

        .service-assignment {
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 16px;
            background: #FAFAFA;
        }

        .service-checkbox {
            display: flex !important;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            margin-bottom: 0 !important;
        }

        .service-checkbox input[type="checkbox"] {
            width: auto !important;
            margin: 0;
        }

        .service-name {
            flex: 1;
            font-size: 14px;
            color: #374151;
            font-weight: 500;
        }

        .priority-select {
            width: auto !important;
            min-width: 100px;
            padding: 4px 8px !important;
            font-size: 12px;
        }

        /* SETTINGS STYLES */
        .settings-section {
            margin-bottom: 24px;
        }

        .settings-description {
            font-size: 14px;
            color: #6B7280;
            margin-bottom: 20px;
        }

        .feature-flags {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .feature-flag-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: #F9FAFB;
            border-radius: 8px;
            border: 1px solid #F3F4F6;
        }

        .flag-info {
            flex: 1;
        }

        .flag-name {
            font-size: 14px;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 4px;
        }

        .flag-description {
            font-size: 12px;
            color: #6B7280;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            cursor: pointer;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #E5E7EB;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #10B981;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .config-items {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .config-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: #F9FAFB;
            border-radius: 8px;
            border: 1px solid #F3F4F6;
        }

        .config-info {
            flex: 1;
        }

        .config-name {
            font-size: 14px;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 4px;
        }

        .config-description {
            font-size: 12px;
            color: #6B7280;
        }

        .config-value {
            min-width: 100px;
        }

        .config-input {
            padding: 6px 12px !important;
            font-size: 14px !important;
            border: 1px solid #E5E7EB !important;
            border-radius: 6px !important;
            text-align: center;
            font-weight: 600;
        }

        .language-selector {
            display: flex;
            gap: 8px;
        }

        .language-option {
            padding: 8px 16px;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            background: #FFFFFF;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
        }

        .language-option.active {
            background: #10B981;
            color: white;
            border-color: #10B981;
        }

        .language-option:hover:not(.active) {
            background: #F3F4F6;
        }

        .branding-items {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .branding-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: #F9FAFB;
            border-radius: 8px;
            border: 1px solid #F3F4F6;
        }

        .branding-info {
            flex: 1;
        }

        .branding-name {
            font-size: 14px;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 4px;
        }

        .branding-description {
            font-size: 12px;
            color: #6B7280;
        }

        .branding-value {
            min-width: 200px;
        }

        .recent-changes {
            max-height: 300px;
            overflow-y: auto;
        }

        .change-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #F9FAFB;
            font-size: 14px;
        }

        .change-item:last-child {
            border-bottom: none;
        }

        .change-time {
            color: #6B7280;
            font-weight: 500;
            min-width: 60px;
        }

        .change-text {
            color: #374151;
            flex: 1;
        }

        .change-user {
            color: #8B5CF6;
            font-weight: 500;
        }

        .save-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #F3F4F6;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .success-message {
            background: #D1FAE5;
            color: #065F46;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
            border: 1px solid #A7F3D0;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        /* UTILITY CLASSES */
        .text-center { text-align: center; }
        .mb-16 { margin-bottom: 16px; }
        .mb-24 { margin-bottom: 24px; }
        .hidden { display: none; }

        /* RESPONSIVE AGENTS */
        @media (max-width: 768px) {
            .agents-stats-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .agents-header-actions {
                flex-direction: column;
                gap: 12px;
            }

            .online-agents-grid {
                grid-template-columns: 1fr;
            }

            .agents-table-container {
                font-size: 12px;
            }

            .agents-table th,
            .agents-table td {
                padding: 8px 12px;
            }

            .agent-services {
                flex-direction: column;
                gap: 8px;
            }

            .agent-performance-grid {
                grid-template-columns: 1fr;
            }

            .performance-metrics {
                grid-template-columns: 1fr;
            }
        }

         <!-- Counters Section -->
                <section id="counters-section" class="admin-section">
                    <div class="section-header">
                        <h2 class="section-title">Counters Management</h2>
                        <p class="section-description">Configure serving counters and locations</p>
                    </div>

                    <!-- Counters Statistics Cards -->
                    <div class="counters-stats-grid">
                        <div class="counter-stat-card">
                            <div class="counter-stat-content">
                                <div class="counter-stat-value" id="totalCounters">5</div>
                                <div class="counter-stat-label">Total Counters</div>
                            </div>
                            <div class="counter-stat-icon">🏪</div>
                        </div>
                        <div class="counter-stat-card">
                            <div class="counter-stat-content">
                                <div class="counter-stat-value" id="activeCounters">2</div>
                                <div class="counter-stat-label">Currently Serving</div>
                            </div>
                            <div class="counter-stat-icon">🟢</div>
                        </div>
                        <div class="counter-stat-card">
                            <div class="counter-stat-content">
                                <div class="counter-stat-value" id="availableCounters">2</div>
                                <div class="counter-stat-label">Available</div>
                            </div>
                            <div class="counter-stat-icon">🟡</div>
                        </div>
                        <div class="counter-stat-card">
                            <div class="counter-stat-content">
                                <div class="counter-stat-value" id="totalServedToday">35</div>
                                <div class="counter-stat-label">Served Today</div>
                            </div>
                            <div class="counter-stat-icon">🎫</div>
                        </div>
                    </div>

                    <!-- Counter Status Overview -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Live Counter Status</h3>
                            <div class="online-count">
                                <span class="online-indicator">●</span>
                                <span id="liveCounterStatus">2 active, 2 available, 1 offline</span>
                            </div>
                        </div>
                        <div class="live-counters-grid" id="liveCountersGrid">
                            <!-- Live counter status will be loaded here -->
                            <div class="live-counter-loading">Loading counter status...</div>
                        </div>
                    </div>

                    <!-- Counters Management -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Counter Configuration</h3>
                            <div class="counters-header-actions">
                                <button class="action-btn primary" onclick="addCounter()">
                                    ➕ Add Counter
                                </button>
                                <div class="search-box">
                                    <input type="text" id="countersSearch" placeholder="Search counters..." onkeyup="filterCounters()">
                                </div>
                            </div>
                        </div>

                        <div class="counters-table-container">
                            <table class="counters-table" id="countersTable">
                                <thead>
                                    <tr>
                                        <th>Counter</th>
                                        <th>Number</th>
                                        <th>Location</th>
                                        <th>Services</th>
                                        <th>Current Status</th>
                                        <th>Current Agent</th>
                                        <th>Today's Performance</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="countersTableBody">
                                    <tr class="loading-row">
                                        <td colspan="8" class="text-center">Loading counters...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Counter Activity Analytics -->
                    <div class="dashboard-grid">
                        <!-- Counter Activity Feed -->
                        <div class="card activity-card">
                            <div class="card-header">
                                <h3 class="card-title">Counter Activity</h3>
                                <button class="refresh-btn" onclick="refreshCounterActivity()">🔄</button>
                            </div>
                            <div class="activity-feed" id="counterActivityFeed">
                                <div class="activity-item loading">
                                    <span class="activity-time">--:--</span>
                                    <span class="activity-text">Loading counter activity...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Counter Performance -->
                        <div class="card queue-status-card">
                            <div class="card-header">
                                <h3 class="card-title">Performance Metrics</h3>
                                <button class="refresh-btn" onclick="refreshCounterStats()">🔄</button>
                            </div>
                            <div class="counter-performance-grid" id="counterPerformanceGrid">
                                <!-- Performance metrics will be loaded here -->
                                <div class="performance-loading">Loading performance data...</div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Add/Edit Counter Modal -->
                <div id="counterModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="counterModalTitle">Add New Counter</h3>
                            <button class="modal-close" onclick="closeCounterModal()">&times;</button>
                        </div>
                        <form id="counterForm" onsubmit="saveCounter(event)">
                            <div class="modal-body">
                                <input type="hidden" id="counterId" name="counterId">
                                
                                <!-- Basic Information -->
                                <div class="form-section">
                                    <h4 class="form-section-title">Basic Information</h4>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="counterName">Counter Name *</label>
                                            <input type="text" id="counterName" name="counterName" required 
                                                   placeholder="e.g., Counter 1, VIP Counter">
                                        </div>
                                        <div class="form-group">
                                            <label for="counterNumber">Counter Number *</label>
                                            <input type="number" id="counterNumber" name="counterNumber" required 
                                                   min="1" max="99" placeholder="1">
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="counterLocation">Location</label>
                                            <input type="text" id="counterLocation" name="counterLocation" 
                                                   placeholder="e.g., Main Hall, VIP Area">
                                        </div>
                                        <div class="form-group">
                                            <label for="counterDescription">Description</label>
                                            <input type="text" id="counterDescription" name="counterDescription" 
                                                   placeholder="Brief description">
                                        </div>
                                    </div>
                                </div>

                                <!-- Service Assignments -->
                                <div class="form-section">
                                    <h4 class="form-section-title">Service Assignments</h4>
                                    <p class="form-section-description">Select which services this counter can handle</p>
                                    
                                    <div class="service-assignments" id="counterServiceAssignments">
                                        <!-- Service checkboxes will be loaded here -->
                                        <div class="service-assignment">
                                            <label class="service-checkbox">
                                                <input type="checkbox" name="counter_services" value="1" data-service="A">
                                                <span class="service-badge general">A</span>
                                                <span class="service-name">General Service</span>
                                            </label>
                                        </div>
                                        <div class="service-assignment">
                                            <label class="service-checkbox">
                                                <input type="checkbox" name="counter_services" value="2" data-service="B">
                                                <span class="service-badge account">B</span>
                                                <span class="service-name">Account Services</span>
                                            </label>
                                        </div>
                                        <div class="service-assignment">
                                            <label class="service-checkbox">
                                                <input type="checkbox" name="counter_services" value="3" data-service="V">
                                                <span class="service-badge vip">V</span>
                                                <span class="service-name">VIP Services</span>
                                            </label>
                                        </div>
                                        <div class="service-assignment">
                                            <label class="service-checkbox">
                                                <input type="checkbox" name="counter_services" value="4" data-service="T">
                                                <span class="service-badge technical">T</span>
                                                <span class="service-name">Technical Support</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Counter Settings -->
                                <div class="form-section">
                                    <h4 class="form-section-title">Counter Settings</h4>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="counterCapacity">Daily Capacity</label>
                                            <input type="number" id="counterCapacity" name="counterCapacity" 
                                                   min="10" max="500" placeholder="100">
                                            <small class="form-help">Expected tickets per day</small>
                                        </div>
                                        <div class="form-group">
                                            <label for="counterPriority">Priority Level</label>
                                            <select id="counterPriority" name="counterPriority">
                                                <option value="1">Normal</option>
                                                <option value="2">High</option>
                                                <option value="3">VIP</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="counterActive" name="counterActive" checked>
                                            <span class="checkmark"></span>
                                            Counter is active and available
                                        </label>
                                    </div>
                                </div>

                                <div class="validation-messages" id="counterValidationMessages"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="action-btn secondary" onclick="closeCounterModal()">
                                    Cancel
                                </button>
                                <button type="submit" class="action-btn primary">
                                    <span id="counterSaveButtonText">Save Counter</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Counter Action Modals -->
                <div id="counterActionModal" class="modal">
                    <div class="modal-content small">
                        <div class="modal-header">
                            <h3 id="counterActionTitle">Counter Action</h3>
                            <button class="modal-close" onclick="closeCounterActionModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p id="counterActionMessage">Are you sure you want to perform this action?</p>
                            <div id="counterActionDetails" class="warning-text"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="action-btn secondary" onclick="closeCounterActionModal()">
                                Cancel
                            </button>
                            <button type="button" class="action-btn primary" id="confirmCounterAction" onclick="confirmCounterAction()">
                                Confirm
                            </button>
                        </div>
                    </div>
                </div>

        /* RESPONSIVE SERVICES */
        @media (max-width: 768px) {
            .services-stats-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .services-header-actions {
                flex-direction: column;
                gap: 12px;
            }

            .search-box input {
                width: 100%;
            }

            .services-table-container {
                font-size: 12px;
            }

            .services-table th,
            .services-table td {
                padding: 8px 12px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 0;
            }

            .modal-content {
                width: 95%;
                margin: 20px;
            }
        }

        /* RESPONSIVE SETTINGS */
        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .language-selector {
                flex-direction: column;
                gap: 8px;
            }

            .config-item,
            .branding-item,
            .feature-flag-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .save-actions {
                flex-direction: column;
                gap: 8px;
            }
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .admin-sidebar {
                position: fixed;
                left: -256px;
                height: 100vh;
                z-index: 200;
                transition: left 0.3s;
            }
            
            .admin-sidebar.open {
                left: 0;
            }
            
            .admin-main {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>FlowMatic Admin</h1>
                <p>System Administration Panel</p>
            </div>
            
            <div id="loginError" class="error-message hidden">
                Invalid password. Please try again.
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="password">Admin Password</label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                
                <button type="submit" id="loginButton" class="login-button">
                    Sign In
                </button>
            </form>
        </div>
    </div>

    <!-- MAIN ADMIN INTERFACE -->
    <div id="adminLayout" class="admin-layout">
        <!-- Header -->
        <header class="admin-header">
            <h1>FlowMatic Administration</h1>
            <div class="admin-header-right">
                <span class="admin-user">Admin User</span>
                <button id="logoutButton" class="logout-button">Logout</button>
            </div>
        </header>

        <div class="admin-content">
            <!-- Sidebar Navigation -->
            <nav class="admin-sidebar">
                <a href="#dashboard" class="nav-item active" data-section="dashboard">
                    <span class="nav-item-icon">🏠</span>
                    Dashboard
                </a>
                <a href="#services" class="nav-item" data-section="services">
                    <span class="nav-item-icon">🔧</span>
                    Services
                </a>
                <a href="#counters" class="nav-item" data-section="counters">
                    <span class="nav-item-icon">🏪</span>
                    Counters
                </a>
                <a href="#agents" class="nav-item" data-section="agents">
                    <span class="nav-item-icon">👥</span>
                    Agents
                </a>
                <a href="#settings" class="nav-item" data-section="settings">
                    <span class="nav-item-icon">⚙️</span>
                    Settings
                </a>
                <a href="#reports" class="nav-item" data-section="reports">
                    <span class="nav-item-icon">📊</span>
                    Reports
                </a>
                <a href="#maintenance" class="nav-item" data-section="maintenance">
                    <span class="nav-item-icon">🛠️</span>
                    Maintenance
                </a>
            </nav>

            <!-- Main Content Area -->
            <main class="admin-main">
                <!-- Dashboard Section -->
                <section id="dashboard-section" class="admin-section active">
                    <div class="section-header">
                        <h2 class="section-title">System Dashboard</h2>
                        <p class="section-description">Real-time overview of your queue management system</p>
                    </div>

                    <!-- Stats Cards Row -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon green">📊</div>
                            <div class="stat-content">
                                <div class="stat-value" id="ticketsToday">--</div>
                                <div class="stat-label">Tickets Today</div>
                            </div>
                            <div class="stat-trend" id="ticketsTrend">+0</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon orange">🎯</div>
                            <div class="stat-content">
                                <div class="stat-value" id="activeQueues">--</div>
                                <div class="stat-label">Active Queues</div>
                            </div>
                            <div class="stat-trend" id="queuesTrend">0 waiting</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon purple">👥</div>
                            <div class="stat-content">
                                <div class="stat-value" id="agentsOnline">--</div>
                                <div class="stat-label">Agents Online</div>
                            </div>
                            <div class="stat-trend" id="agentsTrend">0/0</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon blue">⏱️</div>
                            <div class="stat-content">
                                <div class="stat-value" id="avgWait">--</div>
                                <div class="stat-label">Avg Wait Time</div>
                            </div>
                            <div class="stat-trend" id="waitTrend">minutes</div>
                        </div>
                    </div>

                    <!-- Main Content Grid -->
                    <div class="dashboard-grid">
                        <!-- Live Activity Feed -->
                        <div class="card activity-card">
                            <div class="card-header">
                                <h3 class="card-title">Live Activity</h3>
                                <div class="refresh-indicator" id="activityIndicator">●</div>
                            </div>
                            <div class="activity-feed" id="activityFeed">
                                <div class="activity-item loading">
                                    <span class="activity-time">--:--</span>
                                    <span class="activity-text">Loading system activity...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Queue Status -->
                        <div class="card queue-status-card">
                            <div class="card-header">
                                <h3 class="card-title">Current Queue Status</h3>
                                <button class="refresh-btn" onclick="refreshQueues()">🔄</button>
                            </div>
                            <div class="queue-list" id="queueList">
                                <div class="queue-item loading">
                                    <span class="service-badge">Loading...</span>
                                    <span class="queue-count">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Quick Actions</h3>
                        </div>
                        <div class="quick-actions">
                            <button class="action-btn primary" id="openResetScheduleBtn">
                                ⏰ Edit Reset Schedule
                            </button>
                            <button class="action-btn danger" onclick="resetQueue()">
                                ⚠️ Reset Queues
                            </button>
                            <button class="action-btn secondary" onclick="addAgent()">
                                👤 Add Agent
                            </button>
                            <button class="action-btn info" onclick="toggleFeature()">
                                ⚙️ Toggle Feature
                            </button>
                            <button class="action-btn warning" onclick="systemHealth()">
                                🏥 System Health
                            </button>
                        </div>
                    </div>

                    <!-- Queue Maintenance -->
                    <div class="card maintenance-card">
                        <div class="card-header">
                            <h3 class="card-title">Queue Maintenance</h3>
                        </div>
                        <div class="maintenance-grid">
                            <div class="maintenance-column">
                                <div class="maintenance-meta">
                                    <div class="maintenance-title">Scheduled Reset</div>
                                    <div class="maintenance-summary" id="resetScheduleSummary">Loading schedule…</div>
                                    <div class="maintenance-next" id="nextResetSummary">Next: --</div>
                                    <div class="maintenance-last" id="lastResetSummary">Last: --</div>
                                    <div class="maintenance-status" id="resetStatusFlag"></div>
                                </div>
                                <button class="action-btn danger" id="manualResetButton">
                                    ⚠️ Reset Queues Now
                                </button>
                            </div>
                            <div class="maintenance-divider"></div>
                            <div class="maintenance-column">
                                <div class="maintenance-title">Preset Queue Builder</div>
                                <form id="presetQueueForm" class="preset-form">
                                    <div class="preset-row">
                                        <label>
                                            <span>Service</span>
                                            <select id="presetServiceSelect" required>
                                                <option value="">Select service</option>
                                            </select>
                                        </label>
                                        <label>
                                            <span>Start Number</span>
                                            <input type="number" id="presetStartNumber" value="0" min="0" required>
                                        </label>
                                        <label>
                                            <span>Tickets to Create</span>
                                            <input type="number" id="presetCount" value="20" min="1" max="500" required>
                                        </label>
                                        <label>
                                            <span>Priority</span>
                                            <select id="presetPriority">
                                                <option value="0">Normal</option>
                                                <option value="1">Priority</option>
                                                <option value="2">VIP</option>
                                            </select>
                                        </label>
                                    </div>
                                    <div class="preset-actions">
                                        <button type="submit" class="action-btn primary">Create Queue</button>
                                        <div class="preset-help">
                                            Generates sequential waiting tickets starting after the chosen number.
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- System Health -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">System Health</h3>
                        </div>
                        <div class="health-indicators">
                            <div class="health-item">
                                <span class="health-label">Database</span>
                                <span class="health-status online" id="dbStatus">●</span>
                            </div>
                            <div class="health-item">
                                <span class="health-label">Socket.IO</span>
                                <span class="health-status online" id="socketStatus">●</span>
                            </div>
                            <div class="health-item">
                                <span class="health-label">Memory Usage</span>
                                <span class="health-value" id="memoryUsage">--</span>
                            </div>
                            <div class="health-item">
                                <span class="health-label">Uptime</span>
                                <span class="health-value" id="uptime">--</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Services Section -->
                <section id="services-section" class="admin-section">
                    <div class="section-header">
                        <h2 class="section-title">Services Management</h2>
                        <p class="section-description">Configure and manage your service types</p>
                    </div>

                    <!-- Services Statistics Cards -->
                    <div class="services-stats-grid">
                        <div class="service-stat-card">
                            <div class="service-stat-content">
                                <div class="service-stat-value" id="totalServices">4</div>
                                <div class="service-stat-label">Total Services</div>
                            </div>
                            <div class="service-stat-icon">🔧</div>
                        </div>
                        <div class="service-stat-card">
                            <div class="service-stat-content">
                                <div class="service-stat-value" id="activeServices">4</div>
                                <div class="service-stat-label">Active Services</div>
                            </div>
                            <div class="service-stat-icon">✅</div>
                        </div>
                        <div class="service-stat-card">
                            <div class="service-stat-content">
                                <div class="service-stat-value" id="totalTicketsToday">47</div>
                                <div class="service-stat-label">Tickets Today</div>
                            </div>
                            <div class="service-stat-icon">🎫</div>
                        </div>
                        <div class="service-stat-card">
                            <div class="service-stat-content">
                                <div class="service-stat-value" id="avgServiceTime">4.2m</div>
                                <div class="service-stat-label">Avg Service Time</div>
                            </div>
                            <div class="service-stat-icon">⏱️</div>
                        </div>
                    </div>

                    <!-- Services Management Card -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Services Configuration</h3>
                            <div class="services-header-actions">
                                <button class="action-btn primary" onclick="addService()">
                                    ➕ Add Service
                                </button>
                                <div class="search-box">
                                    <input type="text" id="servicesSearch" placeholder="Search services..." onkeyup="filterServices()">
                                </div>
                            </div>
                        </div>

                        <div class="services-table-container">
                            <table class="services-table" id="servicesTable">
                                <thead>
                                    <tr>
                                        <th>Service Name</th>
                                        <th>Prefix</th>
                                        <th>Number Range</th>
                                        <th>Current Number</th>
                                        <th>Status</th>
                                        <th>Today's Tickets</th>
                                        <th>Avg Wait</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="servicesTableBody">
                                    <!-- Services will be loaded here -->
                                    <tr class="loading-row">
                                        <td colspan="8" class="text-center">Loading services...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Service Performance Card -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Service Performance Today</h3>
                            <button class="refresh-btn" onclick="refreshServiceStats()">🔄</button>
                        </div>
                        <div class="service-performance-grid" id="servicePerformanceGrid">
                            <!-- Performance charts will be loaded here -->
                            <div class="performance-loading">Loading performance data...</div>
                        </div>
                    </div>
                </section>

                <!-- Add/Edit Service Modal -->
                <div id="serviceModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="serviceModalTitle">Add New Service</h3>
                            <button class="modal-close" onclick="closeServiceModal()">&times;</button>
                        </div>
                        <form id="serviceForm" onsubmit="saveService(event)">
                            <div class="modal-body">
                                <input type="hidden" id="serviceId" name="serviceId">
                                
                                <div class="form-group">
                                    <label for="serviceName">Service Name *</label>
                                    <input type="text" id="serviceName" name="serviceName" required 
                                           placeholder="e.g., General Service, VIP Support">
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="servicePrefix">Prefix *</label>
                                        <input type="text" id="servicePrefix" name="servicePrefix" required 
                                               maxlength="3" placeholder="e.g., A, B, VIP" style="text-transform: uppercase;">
                                    </div>
                                    <div class="form-group">
                                        <label for="serviceDescription">Description</label>
                                        <input type="text" id="serviceDescription" name="serviceDescription" 
                                               placeholder="Brief description of the service">
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="rangeStart">Range Start *</label>
                                        <input type="number" id="rangeStart" name="rangeStart" required 
                                               min="1" max="9999" placeholder="1">
                                    </div>
                                    <div class="form-group">
                                        <label for="rangeEnd">Range End *</label>
                                        <input type="number" id="rangeEnd" name="rangeEnd" required 
                                               min="1" max="9999" placeholder="999">
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="currentNumber">Current Number</label>
                                        <input type="number" id="currentNumber" name="currentNumber" 
                                               min="0" placeholder="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="estimatedServiceTime">Est. Service Time (seconds)</label>
                                        <input type="number" id="estimatedServiceTime" name="estimatedServiceTime" 
                                               min="30" max="3600" placeholder="300">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="isActive" name="isActive" checked>
                                        <span class="checkmark"></span>
                                        Service is active
                                    </label>
                                </div>

                                <div class="validation-messages" id="validationMessages"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="action-btn secondary" onclick="closeServiceModal()">
                                    Cancel
                                </button>
                                <button type="submit" class="action-btn primary">
                                    <span id="saveButtonText">Save Service</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Confirm Delete Modal -->
                <div id="deleteConfirmModal" class="modal">
                    <div class="modal-content small">
                        <div class="modal-header">
                            <h3>Confirm Delete</h3>
                            <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete the service "<span id="deleteServiceName"></span>"?</p>
                            <p class="warning-text">⚠️ This action cannot be undone. Any active tickets for this service will be affected.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="action-btn secondary" onclick="closeDeleteModal()">
                                Cancel
                            </button>
                            <button type="button" class="action-btn warning" onclick="confirmDeleteService()">
                                Delete Service
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Counters Section -->
                <section id="counters-section" class="admin-section">
                    <div class="section-header">
                        <h2 class="section-title">Counters Management</h2>
                        <p class="section-description">Configure serving counters and locations</p>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Counters List</h3>
                        </div>
                        <p>Counters management will be implemented here...</p>
                    </div>
                </section>

                <!-- Agents Section -->
                <section id="agents-section" class="admin-section">
                    <div class="section-header">
                        <h2 class="section-title">Agents Management</h2>
                        <p class="section-description">Manage staff members and service assignments</p>
                    </div>

                    <!-- Agents Statistics Cards -->
                    <div class="agents-stats-grid">
                        <div class="agent-stat-card">
                            <div class="agent-stat-content">
                                <div class="agent-stat-value" id="totalAgents">5</div>
                                <div class="agent-stat-label">Total Agents</div>
                            </div>
                            <div class="agent-stat-icon">👥</div>
                        </div>
                        <div class="agent-stat-card">
                            <div class="agent-stat-content">
                                <div class="agent-stat-value" id="onlineAgents">3</div>
                                <div class="agent-stat-label">Online Now</div>
                            </div>
                            <div class="agent-stat-icon">🟢</div>
                        </div>
                        <div class="agent-stat-card">
                            <div class="agent-stat-content">
                                <div class="agent-stat-value" id="topPerformer">John S.</div>
                                <div class="agent-stat-label">Top Performer</div>
                            </div>
                            <div class="agent-stat-icon">🏆</div>
                        </div>
                        <div class="agent-stat-card">
                            <div class="agent-stat-content">
                                <div class="agent-stat-value" id="totalTicketsServed">47</div>
                                <div class="agent-stat-label">Tickets Served Today</div>
                            </div>
                            <div class="agent-stat-icon">🎫</div>
                        </div>
                    </div>

                    <!-- Online Agents Quick View -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Currently Online</h3>
                            <div class="online-count">
                                <span class="online-indicator">●</span>
                                <span id="liveOnlineCount">3 agents online</span>
                            </div>
                        </div>
                        <div class="online-agents-grid" id="onlineAgentsGrid">
                            <!-- Online agents will be loaded here -->
                            <div class="online-agent-loading">Loading online agents...</div>
                        </div>
                    </div>

                    <!-- Agents Management -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">All Agents</h3>
                            <div class="agents-header-actions">
                                <button class="action-btn primary" onclick="addAgent()">
                                    ➕ Add Agent
                                </button>
                                <div class="search-box">
                                    <input type="text" id="agentsSearch" placeholder="Search agents..." onkeyup="filterAgents()">
                                </div>
                            </div>
                        </div>

                        <div class="agents-table-container">
                            <table class="agents-table" id="agentsTable">
                                <thead>
                                    <tr>
                                        <th>Agent</th>
                                        <th>Username</th>
                                        <th>Status</th>
                                        <th>Assigned Services</th>
                                        <th>Current Counter</th>
                                        <th>Today's Performance</th>
                                        <th>Role</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="agentsTableBody">
                                    <tr class="loading-row">
                                        <td colspan="8" class="text-center">Loading agents...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Agent Performance Analytics -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Performance Analytics (Today)</h3>
                            <button class="refresh-btn" onclick="refreshAgentStats()">🔄</button>
                        </div>
                        <div class="agent-performance-grid" id="agentPerformanceGrid">
                            <!-- Performance charts will be loaded here -->
                            <div class="performance-loading">Loading performance data...</div>
                        </div>
                    </div>
                </section>

                <!-- Add/Edit Agent Modal -->
                <div id="agentModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="agentModalTitle">Add New Agent</h3>
                            <button class="modal-close" onclick="closeAgentModal()">&times;</button>
                        </div>
                        <form id="agentForm" onsubmit="saveAgent(event)">
                            <div class="modal-body">
                                <input type="hidden" id="agentId" name="agentId">
                                
                                <!-- Basic Information -->
                                <div class="form-section">
                                    <h4 class="form-section-title">Basic Information</h4>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="agentName">Full Name *</label>
                                            <input type="text" id="agentName" name="agentName" required 
                                                   placeholder="e.g., John Smith">
                                        </div>
                                        <div class="form-group">
                                            <label for="agentUsername">Username *</label>
                                            <input type="text" id="agentUsername" name="agentUsername" required 
                                                   placeholder="e.g., jsmith" style="text-transform: lowercase;">
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="agentEmail">Email</label>
                                            <input type="email" id="agentEmail" name="agentEmail" 
                                                   placeholder="john.smith@company.com">
                                        </div>
                                        <div class="form-group">
                                            <label for="agentRole">Role</label>
                                            <select id="agentRole" name="agentRole">
                                                <option value="agent">Agent</option>
                                                <option value="supervisor">Supervisor</option>
                                                <option value="admin">Admin</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Service Assignments -->
                                <div class="form-section">
                                    <h4 class="form-section-title">Service Assignments</h4>
                                    <p class="form-section-description">Select which services this agent can handle</p>
                                    
                                    <div class="service-assignments" id="serviceAssignments">
                                        <!-- Service checkboxes will be loaded here -->
                                        <div class="service-assignment">
                                            <label class="service-checkbox">
                                                <input type="checkbox" name="services" value="1" data-service="A">
                                                <span class="service-badge general">A</span>
                                                <span class="service-name">General Service</span>
                                                <select class="priority-select" name="priority_1">
                                                    <option value="1">Primary</option>
                                                    <option value="2">Secondary</option>
                                                </select>
                                            </label>
                                        </div>
                                        <div class="service-assignment">
                                            <label class="service-checkbox">
                                                <input type="checkbox" name="services" value="2" data-service="B">
                                                <span class="service-badge account">B</span>
                                                <span class="service-name">Account Services</span>
                                                <select class="priority-select" name="priority_2">
                                                    <option value="1">Primary</option>
                                                    <option value="2">Secondary</option>
                                                </select>
                                            </label>
                                        </div>
                                        <div class="service-assignment">
                                            <label class="service-checkbox">
                                                <input type="checkbox" name="services" value="3" data-service="V">
                                                <span class="service-badge vip">V</span>
                                                <span class="service-name">VIP Services</span>
                                                <select class="priority-select" name="priority_3">
                                                    <option value="1">Primary</option>
                                                    <option value="2">Secondary</option>
                                                </select>
                                            </label>
                                        </div>
                                        <div class="service-assignment">
                                            <label class="service-checkbox">
                                                <input type="checkbox" name="services" value="4" data-service="T">
                                                <span class="service-badge technical">T</span>
                                                <span class="service-name">Technical Support</span>
                                                <select class="priority-select" name="priority_4">
                                                    <option value="1">Primary</option>
                                                    <option value="2">Secondary</option>
                                                </select>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Account Settings -->
                                <div class="form-section">
                                    <h4 class="form-section-title">Account Settings</h4>
                                    
                                    <div class="form-group">
                                        <label for="agentPassword">Password</label>
                                        <input type="password" id="agentPassword" name="agentPassword" 
                                               placeholder="Leave blank to keep current password">
                                        <small class="form-help">For new agents, a temporary password will be generated</small>
                                    </div>

                                    <div class="form-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="agentActive" name="agentActive" checked>
                                            <span class="checkmark"></span>
                                            Agent account is active
                                        </label>
                                    </div>
                                </div>

                                <div class="validation-messages" id="agentValidationMessages"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="action-btn secondary" onclick="closeAgentModal()">
                                    Cancel
                                </button>
                                <button type="submit" class="action-btn primary">
                                    <span id="agentSaveButtonText">Save Agent</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Confirm Delete Agent Modal -->
                <div id="deleteAgentModal" class="modal">
                    <div class="modal-content small">
                        <div class="modal-header">
                            <h3>Confirm Delete Agent</h3>
                            <button class="modal-close" onclick="closeDeleteAgentModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete agent "<span id="deleteAgentName"></span>"?</p>
                            <p class="warning-text">⚠️ This will remove the agent's access and cannot be undone.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="action-btn secondary" onclick="closeDeleteAgentModal()">
                                Cancel
                            </button>
                            <button type="button" class="action-btn warning" onclick="confirmDeleteAgent()">
                                Delete Agent
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Reset Schedule Modal -->
                <div id="resetScheduleModal" class="modal">
                    <div class="modal-content small">
                        <div class="modal-header">
                            <h3>Queue Reset Schedule</h3>
                            <button class="modal-close" onclick="closeResetScheduleModal()">&times;</button>
                        </div>
                        <form id="resetScheduleForm">
                            <div class="modal-body">
                                <div class="form-group">
                                    <label for="resetScheduleTime">Reset Time (HH:MM)</label>
                                    <input type="time" id="resetScheduleTime" required>
                                </div>
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="resetScheduleEnabled">
                                        <span class="checkmark"></span>
                                        Enable automatic daily reset
                                    </label>
                                </div>
                                <p class="form-section-description">
                                    When enabled, all queues will be cleared at the scheduled time each day.
                                </p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="action-btn secondary" onclick="closeResetScheduleModal()">
                                    Cancel
                                </button>
                                <button type="submit" class="action-btn primary" id="resetScheduleSaveButton">
                                    Save Schedule
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Settings Section -->
                <section id="settings-section" class="admin-section">
                    <div class="section-header">
                        <h2 class="section-title">System Settings</h2>
                        <p class="section-description">Configure system features and global options</p>
                    </div>

                    <!-- Settings Overview Cards -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon green">🚀</div>
                            <div class="stat-content">
                                <div class="stat-value" id="enabledFeatures">2</div>
                                <div class="stat-label">Features Enabled</div>
                            </div>
                            <div class="stat-trend">of 6 total</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon orange">⚙️</div>
                            <div class="stat-content">
                                <div class="stat-value" id="configItems">8</div>
                                <div class="stat-label">Config Items</div>
                            </div>
                            <div class="stat-trend">configured</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon purple">🌐</div>
                            <div class="stat-content">
                                <div class="stat-value" id="systemLanguage">EN</div>
                                <div class="stat-label">System Language</div>
                            </div>
                            <div class="stat-trend">3 available</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon blue">📝</div>
                            <div class="stat-content">
                                <div class="stat-value" id="recentChanges">3</div>
                                <div class="stat-label">Recent Changes</div>
                            </div>
                            <div class="stat-trend">today</div>
                        </div>
                    </div>

                    <!-- Settings Management Grid -->
                    <div class="settings-grid">
                        <!-- Feature Flags -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Feature Flags</h3>
                                <button class="refresh-btn" onclick="refreshSettings()">🔄</button>
                            </div>
                            <div class="settings-section">
                                <p class="settings-description">Enable or disable advanced features</p>
                                
                                <div class="feature-flags" id="featureFlags">
                                    <div class="feature-flag-item">
                                        <div class="flag-info">
                                            <div class="flag-name">Park/Unpark Tickets</div>
                                            <div class="flag-description">Allow agents to temporarily park tickets</div>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="feature_park_unpark" data-feature="park_unpark">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>

                                    <div class="feature-flag-item">
                                        <div class="flag-info">
                                            <div class="flag-name">Cherry Pick Tickets</div>
                                            <div class="flag-description">Allow calling any specific ticket number</div>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="feature_cherry_pick" data-feature="cherry_pick">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>

                                    <div class="feature-flag-item">
                                        <div class="flag-info">
                                            <div class="flag-name">Recycle Tickets</div>
                                            <div class="flag-description">Return completed tickets back to queue</div>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="feature_recycle" data-feature="recycle">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>

                                    <div class="feature-flag-item">
                                        <div class="flag-info">
                                            <div class="flag-name">Multi-Service Priority</div>
                                            <div class="flag-description">Advanced service priority management</div>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="feature_multi_service" data-feature="multi_service">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>

                                    <div class="feature-flag-item">
                                        <div class="flag-info">
                                            <div class="flag-name">Voice Announcements</div>
                                            <div class="flag-description">Text-to-speech announcements</div>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="feature_voice" data-feature="voice_announcements" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>

                                    <div class="feature-flag-item">
                                        <div class="flag-info">
                                            <div class="flag-name">Multi-Language Support</div>
                                            <div class="flag-description">English, Thai, Hindi language options</div>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="feature_languages" data-feature="languages" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- System Configuration -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">System Configuration</h3>
                            </div>
                            <div class="settings-section">
                                <p class="settings-description">Configure system behavior and limits</p>
                                
                                <div class="config-items" id="configItems">
                                    <div class="config-item">
                                        <div class="config-info">
                                            <div class="config-name">Max Recall Count</div>
                                            <div class="config-description">Maximum times a ticket can be recalled</div>
                                        </div>
                                        <div class="config-value">
                                            <input type="number" class="config-input" id="config_max_recall" value="3" min="1" max="10">
                                        </div>
                                    </div>

                                    <div class="config-item">
                                        <div class="config-info">
                                            <div class="config-name">Auto-Complete Timeout</div>
                                            <div class="config-description">Auto-complete serving tickets after (minutes)</div>
                                        </div>
                                        <div class="config-value">
                                            <input type="number" class="config-input" id="config_auto_complete" value="30" min="5" max="120">
                                        </div>
                                    </div>

                                    <div class="config-item">
                                        <div class="config-info">
                                            <div class="config-name">Recycle Position</div>
                                            <div class="config-description">Queue position for recycled tickets</div>
                                        </div>
                                        <div class="config-value">
                                            <input type="number" class="config-input" id="config_recycle_position" value="3" min="1" max="10">
                                        </div>
                                    </div>

                                    <div class="config-item">
                                        <div class="config-info">
                                            <div class="config-name">Daily Reset Time</div>
                                            <div class="config-description">Automatic queue reset time (24h format)</div>
                                        </div>
                                        <div class="config-value">
                                            <input type="time" class="config-input" id="config_reset_time" value="00:00">
                                        </div>
                                    </div>

                                    <div class="config-item">
                                        <div class="config-info">
                                            <div class="config-name">Daily Reset Enabled</div>
                                            <div class="config-description">Enable automatic daily queue reset</div>
                                        </div>
                                        <div class="config-value">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="config_daily_reset" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Branding & Language -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Branding & Language</h3>
                            </div>
                            <div class="settings-section">
                                <p class="settings-description">System branding and language settings</p>
                                
                                <div class="branding-items" id="brandingItems">
                                    <div class="branding-item">
                                        <div class="branding-info">
                                            <div class="branding-name">System Name</div>
                                            <div class="branding-description">Display name for the system</div>
                                        </div>
                                        <div class="branding-value">
                                            <input type="text" class="config-input" id="branding_system_name" value="FlowMatic-SOLO" style="width: 100%;">
                                        </div>
                                    </div>

                                    <div class="branding-item">
                                        <div class="branding-info">
                                            <div class="branding-name">Global Language</div>
                                            <div class="branding-description">System-wide interface language</div>
                                        </div>
                                        <div class="branding-value">
                                            <div class="language-selector">
                                                <div class="language-option active" data-lang="en">🇺🇸 EN</div>
                                                <div class="language-option" data-lang="th">🇹🇭 TH</div>
                                                <div class="language-option" data-lang="hi">🇮🇳 HI</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="branding-item">
                                        <div class="branding-info">
                                            <div class="branding-name">System Version</div>
                                            <div class="branding-description">Current software version</div>
                                        </div>
                                        <div class="branding-value">
                                            <input type="text" class="config-input" id="branding_version" value="2.0.0" readonly style="background: #F3F4F6;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Changes -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Recent Changes</h3>
                            <button class="refresh-btn" onclick="refreshChanges()">🔄</button>
                        </div>
                        <div class="recent-changes" id="recentChanges">
                            <div class="change-item">
                                <span class="change-time">14:25</span>
                                <span class="change-text">Voice announcements enabled</span>
                                <span class="change-user">Admin</span>
                            </div>
                            <div class="change-item">
                                <span class="change-time">13:45</span>
                                <span class="change-text">Max recalls changed to 3</span>
                                <span class="change-user">Admin</span>
                            </div>
                            <div class="change-item">
                                <span class="change-time">12:30</span>
                                <span class="change-text">System language set to English</span>
                                <span class="change-user">Admin</span>
                            </div>
                        </div>
                    </div>

                    <!-- Save Actions -->
                    <div class="save-actions">
                        <div id="settingsSuccess" class="success-message">
                            Settings saved successfully!
                        </div>
                        <button type="button" class="action-btn secondary" onclick="resetToDefaults()">
                            Reset to Defaults
                        </button>
                        <button type="button" class="action-btn info" onclick="exportSettings()">
                            Export Config
                        </button>
                        <button type="button" class="action-btn primary" onclick="saveAllSettings()">
                            Save All Changes
                        </button>
                    </div>
                </section>

                <!-- Reports Section -->
                <section id="reports-section" class="admin-section">
                    <div class="section-header">
                        <h2 class="section-title">Reports & Analytics</h2>
                        <p class="section-description">Business intelligence and performance metrics</p>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Performance Reports</h3>
                        </div>
                        <p>Reports and analytics will be implemented here...</p>
                    </div>
                </section>

                <!-- Maintenance Section -->
                <section id="maintenance-section" class="admin-section">
                    <div class="section-header">
                        <h2 class="section-title">System Maintenance</h2>
                        <p class="section-description">System health monitoring and maintenance tools</p>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">System Health</h3>
                        </div>
                        <p>Maintenance tools will be implemented here...</p>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <script>
        // Admin Panel JavaScript
        class AdminPanel {
            constructor() {
                this.apiBase = `${window.location.protocol}//${window.location.host}/api`;
                this.token = localStorage.getItem('admin_token');
                this.currentSection = 'dashboard';
                this.settingsData = {};
                this.resetStatus = null;
                
                this.initializeEventListeners();
                
                // Check if already logged in
                if (this.token) {
                    this.verifyToken();
                } else {
                    this.showLogin();
                }
            }

            initializeEventListeners() {
                // Login form
                document.getElementById('loginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });

                // Logout button
                document.getElementById('logoutButton').addEventListener('click', () => {
                    this.handleLogout();
                });

                // Navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = item.dataset.section;
                        this.showSection(section);
                    });
                });

                // Settings event listeners
                this.initializeSettingsEventListeners();
                this.initializeMaintenanceEventListeners();
            }

            initializeSettingsEventListeners() {
                // Feature flag toggles
                document.querySelectorAll('.feature-flags input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        this.handleFeatureToggle(e.target);
                    });
                });

                // Config input changes
                document.querySelectorAll('.config-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        this.handleConfigChange(e.target);
                    });
                });

                // Language selector
                document.querySelectorAll('.language-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        this.handleLanguageChange(e.target);
                    });
                });
            }

            initializeMaintenanceEventListeners() {
                const openScheduleButton = document.getElementById('openResetScheduleBtn');
                if (openScheduleButton) {
                    openScheduleButton.addEventListener('click', () => this.openResetScheduleModal());
                }

                const manualResetButton = document.getElementById('manualResetButton');
                if (manualResetButton) {
                    manualResetButton.addEventListener('click', () => this.confirmManualReset());
                }

                const scheduleForm = document.getElementById('resetScheduleForm');
                if (scheduleForm) {
                    scheduleForm.addEventListener('submit', (event) => this.submitResetSchedule(event));
                }

                const presetForm = document.getElementById('presetQueueForm');
                if (presetForm) {
                    presetForm.addEventListener('submit', (event) => {
                        event.preventDefault();
                        this.handlePresetQueueSubmit();
                    });
                }
            }

            async handleLogin() {
                const password = document.getElementById('password').value;
                const loginButton = document.getElementById('loginButton');
                const errorDiv = document.getElementById('loginError');

                loginButton.disabled = true;
                loginButton.textContent = 'Signing in...';
                errorDiv.classList.add('hidden');

                try {
                    const response = await fetch(`${this.apiBase}/admin/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ password })
                    });

                    const data = await response.json();

                    if (response.ok && data.token) {
                        this.token = data.token;
                        localStorage.setItem('admin_token', this.token);
                        this.showAdminPanel();
                    } else {
                        errorDiv.classList.remove('hidden');
                        document.getElementById('password').value = '';
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    errorDiv.textContent = 'Connection error. Please try again.';
                    errorDiv.classList.remove('hidden');
                } finally {
                    loginButton.disabled = false;
                    loginButton.textContent = 'Sign In';
                }
            }

            async verifyToken() {
                try {
                    const response = await fetch(`${this.apiBase}/admin/verify`, {
                        headers: {
                            'Authorization': `Bearer ${this.token}`
                        }
                    });

                    if (response.ok) {
                        this.showAdminPanel();
                    } else {
                        this.handleLogout();
                    }
                } catch (error) {
                    console.error('Token verification error:', error);
                    this.handleLogout();
                }
            }

            handleLogout() {
                this.token = null;
                localStorage.removeItem('admin_token');
                this.showLogin();
            }

            async confirmManualReset() {
                const confirmation = confirm(
                    'This will clear all queues, delete waiting/called tickets, and reset counters. Continue?'
                );
                if (!confirmation) {
                    return;
                }
                await this.runManualReset();
            }

            openResetScheduleModal() {
                const modal = document.getElementById('resetScheduleModal');
                if (!modal) return;

                const timeInput = document.getElementById('resetScheduleTime');
                const enabledCheckbox = document.getElementById('resetScheduleEnabled');

                const status = this.resetStatus || {};
                if (timeInput) {
                    timeInput.value = status.resetTime || '00:00';
                }
                if (enabledCheckbox) {
                    enabledCheckbox.checked = status.enabled ?? false;
                }

                modal.classList.add('show');
            }

            closeResetScheduleModal() {
                const modal = document.getElementById('resetScheduleModal');
                if (modal) {
                    modal.classList.remove('show');
                }
            }

            async submitResetSchedule(event) {
                event.preventDefault();

                const timeInput = document.getElementById('resetScheduleTime');
                const enabledCheckbox = document.getElementById('resetScheduleEnabled');
                const saveButton = document.getElementById('resetScheduleSaveButton');

                const resetTime = timeInput?.value || '00:00';
                const enabled = enabledCheckbox?.checked ?? false;

                if (!/^([01]?\d|2[0-3]):([0-5]\d)$/.test(resetTime)) {
                    this.showError('Reset time must be in HH:MM format (24-hour).');
                    return;
                }

                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.textContent = 'Saving...';
                }

                try {
                    const response = await this.apiCall('/admin/system/reset-config', {
                        method: 'PUT',
                        body: JSON.stringify({
                            resetTime,
                            dailyReset: enabled
                        })
                    });

                    if (!response.ok) {
                        const payload = await response.json().catch(() => ({}));
                        throw new Error(payload.error || 'Failed to update reset schedule');
                    }

                    this.showSuccess('Reset schedule updated.');
                    this.closeResetScheduleModal();
                    await this.loadResetStatus();
                } catch (error) {
                    console.error('Reset schedule update error:', error);
                    this.showError(error.message || 'Failed to update reset schedule');
                } finally {
                    if (saveButton) {
                        saveButton.disabled = false;
                        saveButton.textContent = 'Save Schedule';
                    }
                }
            }

            async runManualReset() {
                const button = document.getElementById('manualResetButton');
                if (button) {
                    button.disabled = true;
                    button.textContent = 'Resetting...';
                }

                try {
                    const response = await this.apiCall('/admin/system/reset', {
                        method: 'POST',
                        body: JSON.stringify({ reason: 'manual' })
                    });
                    const payload = await response.json().catch(() => ({}));

                    if (!response.ok) {
                        throw new Error(payload.error || 'Failed to reset queues');
                    }

                    this.showSuccess('All queues cleared successfully.');
                    await this.refreshQueueStatus();
                    await this.loadResetStatus();
                } catch (error) {
                    console.error('Manual reset error:', error);
                    this.showError(error.message || 'Failed to reset queues');
                } finally {
                    if (button) {
                        button.disabled = false;
                        button.textContent = '⚠️ Reset Queues Now';
                    }
                }
            }

            async handlePresetQueueSubmit() {
                const serviceSelect = document.getElementById('presetServiceSelect');
                const startInput = document.getElementById('presetStartNumber');
                const countInput = document.getElementById('presetCount');
                const prioritySelect = document.getElementById('presetPriority');
                const submitButton = document.querySelector('#presetQueueForm button[type="submit"]');

                const serviceId = parseInt(serviceSelect?.value, 10);
                const startNumber = parseInt(startInput?.value, 10);
                const count = parseInt(countInput?.value, 10);
                const priority = parseInt(prioritySelect?.value, 10) || 0;

                if (!Number.isInteger(serviceId)) {
                    this.showError('Select a service before creating preset tickets.');
                    return;
                }
                if (!Number.isInteger(startNumber) || startNumber < 0) {
                    this.showError('Start number must be zero or greater.');
                    return;
                }
                if (!Number.isInteger(count) || count <= 0) {
                    this.showError('Number of tickets must be a positive integer.');
                    return;
                }

                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.textContent = 'Generating...';
                }

                try {
                    const response = await this.apiCall('/admin/system/preset-queue', {
                        method: 'POST',
                        body: JSON.stringify({
                            serviceId,
                            startNumber,
                            count,
                            priority
                        })
                    });
                    const payload = await response.json().catch(() => ({}));
                    if (!response.ok) {
                        throw new Error(payload.error || 'Failed to create preset queue');
                    }

                    const created = payload.result?.insertedTickets?.length ?? count;
                    const skipped = payload.result?.skippedTickets?.length ?? 0;
                    const serviceName = this.getServiceNameById(serviceId);

                    const message = skipped
                        ? `Created ${created} ticket(s) for ${serviceName}. Skipped ${skipped} existing numbers.`
                        : `Created ${created} ticket(s) for ${serviceName}.`;

                    this.showSuccess(message);
                    await this.refreshQueueStatus();
                } catch (error) {
                    console.error('Preset queue error:', error);
                    this.showError(error.message || 'Failed to create preset queue');
                } finally {
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.textContent = 'Create Queue';
                    }
                }
            }

            async loadResetStatus() {
                const status = await this.fetchResetStatus();
                this.updateResetStatusDisplay(status);
            }

            async fetchResetStatus() {
                try {
                    const response = await this.apiCall('/admin/system/reset-status');
                    if (!response.ok) {
                        throw new Error('Failed to load reset status');
                    }
                    const payload = await response.json();
                    return payload.status || payload;
                } catch (error) {
                    console.error('Reset status error:', error);
                    return null;
                }
            }

            updateResetStatusDisplay(status) {
                this.resetStatus = status || null;

                const summaryEl = document.getElementById('resetScheduleSummary');
                const nextEl = document.getElementById('nextResetSummary');
                const lastEl = document.getElementById('lastResetSummary');
                const flagEl = document.getElementById('resetStatusFlag');
                const button = document.getElementById('manualResetButton');

                const enabled = status?.enabled === true;
                const resetTime = status?.resetTime || '00:00';

                if (summaryEl) {
                    summaryEl.textContent = enabled
                        ? `Enabled • Daily at ${resetTime}`
                        : 'Automatic reset disabled';
                }

                if (nextEl) {
                    nextEl.textContent = status?.nextRunAt
                        ? `Next: ${this.formatDateTime(status.nextRunAt)}`
                        : 'Next: --';
                }

                if (lastEl) {
                    lastEl.textContent = status?.lastResetAt
                        ? `Last: ${this.formatDateTime(status.lastResetAt)}${status.lastResetReason ? ` (${status.lastResetReason})` : ''}`
                        : 'Last: --';
                }

                if (flagEl) {
                    flagEl.textContent = status?.inProgress ? 'Reset in progress…' : '';
                    flagEl.style.color = status?.inProgress ? '#DC2626' : '#047857';
                }

                if (button) {
                    button.disabled = Boolean(status?.inProgress);
                    if (status?.inProgress) {
                        button.textContent = 'Resetting...';
                    } else {
                        button.textContent = '⚠️ Reset Queues Now';
                    }
                }
            }

            populatePresetServiceOptions(services = []) {
                const select = document.getElementById('presetServiceSelect');
                if (!select) return;

                const previousValue = select.value;
                select.innerHTML = '<option value="">Select service</option>';

                services.forEach((service) => {
                    const option = document.createElement('option');
                    option.value = service.id;
                    option.textContent = `${service.prefix || ''} ${service.name}`;
                    select.appendChild(option);
                });

                if (previousValue && services.some((service) => String(service.id) === String(previousValue))) {
                    select.value = previousValue;
                }
            }

            getServiceNameById(serviceId) {
                const service = this.servicesData?.find((s) => Number(s.id) === Number(serviceId));
                return service ? service.name : `Service ${serviceId}`;
            }

            getServiceBadgeClass(prefix = '') {
                const upper = String(prefix).toUpperCase();
                switch (upper) {
                    case 'A':
                        return 'general';
                    case 'B':
                        return 'account';
                    case 'C':
                    case 'V':
                        return 'vip';
                    case 'D':
                        return 'technical';
                    default:
                        return 'general';
                }
            }

            formatDateTime(value) {
                if (!value) {
                    return '--';
                }
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) {
                    return '--';
                }
                return date.toLocaleString('en-US', {
                    hour12: false,
                    year: 'numeric',
                    month: 'short',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            showLogin() {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('adminLayout').style.display = 'none';
                document.getElementById('password').focus();
            }

            showAdminPanel() {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminLayout').style.display = 'block';
                this.showSection(this.currentSection);
            }

            showSection(sectionName) {
                // Update navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');

                // Update content
                document.querySelectorAll('.admin-section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(`${sectionName}-section`).classList.add('active');

                this.currentSection = sectionName;
                
                // Update URL hash
                window.location.hash = sectionName;

                // Load section-specific data
                this.loadSectionData(sectionName);
            }

            async loadSectionData(sectionName) {
                // Section-specific data loading
                console.log(`Loading data for section: ${sectionName}`);
                
                switch(sectionName) {
                    case 'dashboard':
                        await this.loadDashboardData();
                        break;
                    case 'services':
                        await this.loadServicesData();
                        break;
                    case 'agents':
                        await this.loadAgentsData();
                        break;
                    case 'settings':
                        await this.loadSettingsData();
                        break;
                    default:
                        console.log(`No specific loader for ${sectionName}`);
                }
            }

            async loadDashboardData() {
                try {
                    // Load all dashboard data in parallel
                    const [
                        statsData,
                        activityData,
                        queueData,
                        healthData,
                        services,
                        resetStatus
                    ] = await Promise.all([
                        this.loadTodayStats(),
                        this.loadRecentActivity(),
                        this.loadQueueStatus(),
                        this.loadSystemHealth(),
                        this.loadServicesList().catch(() => []),
                        this.fetchResetStatus()
                    ]);

                    this.updateStatsCards(statsData);
                    this.updateActivityFeed(activityData);
                    this.updateQueueStatus(queueData);
                    this.updateSystemHealth(healthData);

                    if (Array.isArray(services) && services.length > 0) {
                        this.servicesData = services;
                        this.populatePresetServiceOptions(services);
                    }

                    this.updateResetStatusDisplay(resetStatus);

                    // Setup real-time updates
                    this.setupDashboardRealtime();
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    this.updateResetStatusDisplay(null);
                }
            }

            async loadTodayStats() {
                try {
                    const response = await this.apiCall('/admin/dashboard/summary');
                    if (!response.ok) {
                        throw new Error('Failed to fetch summary');
                    }
                    const payload = await response.json();
                    return payload.summary || {
                        ticketsToday: 0,
                        activeQueues: 0,
                        waitingTickets: 0,
                        agentsOnline: 0,
                        totalAgents: 0,
                        avgWaitMinutes: 0
                    };
                } catch (error) {
                    console.error('Error loading stats:', error);
                    return {
                        ticketsToday: 0,
                        activeQueues: 0,
                        waitingTickets: 0,
                        agentsOnline: 0,
                        totalAgents: 0,
                        avgWaitMinutes: 0
                    };
                }
            }

            async loadRecentActivity() {
                try {
                    const response = await this.apiCall('/admin/dashboard/activity');
                    if (!response.ok) {
                        throw new Error('Failed to fetch activity');
                    }
                    const payload = await response.json();
                    return payload.activity || [];
                } catch (error) {
                    console.error('Error loading activity:', error);
                    return [];
                }
            }

            async loadQueueStatus() {
                try {
                    const response = await this.apiCall('/admin/dashboard/queues');
                    if (!response.ok) {
                        throw new Error('Failed to fetch queue status');
                    }
                    const payload = await response.json();
                    return payload.queues || [];
                } catch (error) {
                    console.error('Error loading queue status:', error);
                    return [];
                }
            }

            async loadSystemHealth() {
                try {
                    // Check system health
                    const healthResponse = await fetch(`${this.apiBase}/health`);
                    const isHealthy = healthResponse.ok;
                    
                    return {
                        database: isHealthy ? 'online' : 'offline',
                        socket: 'online', // We're connected if we got here
                        memory: '45%',
                        uptime: '2d 14h 32m'
                    };
                } catch (error) {
                    console.error('Error checking system health:', error);
                    return {
                        database: 'offline',
                        socket: 'offline',
                        memory: '--',
                        uptime: '--'
                    };
                }
            }

            updateStatsCards(stats) {
                const ticketsToday = stats.ticketsToday ?? 0;
                const activeQueues = stats.activeQueues ?? 0;
                const agentsOnline = stats.agentsOnline ?? 0;
                const totalAgents = stats.totalAgents ?? 0;
                const waitingTickets = stats.waitingTickets ?? 0;
                const avgWait = stats.avgWaitMinutes ?? 0;

                document.getElementById('ticketsToday').textContent = ticketsToday;
                document.getElementById('activeQueues').textContent = activeQueues;
                document.getElementById('agentsOnline').textContent = agentsOnline;
                document.getElementById('avgWait').textContent = `${avgWait}m`;

                document.getElementById('ticketsTrend').textContent = `${waitingTickets} waiting`;
                document.getElementById('queuesTrend').textContent = `${waitingTickets} waiting`;
                document.getElementById('agentsTrend').textContent = `${agentsOnline}/${totalAgents}`;
                document.getElementById('waitTrend').textContent = 'minutes';
            }

            updateActivityFeed(activities) {
                const feed = document.getElementById('activityFeed');
                feed.innerHTML = '';

                activities.forEach(activity => {
                    const item = document.createElement('div');
                    item.className = 'activity-item';
                    item.innerHTML = `
                        <span class="activity-time">${this.formatTime(new Date(activity.timestamp))}</span>
                        <span class="activity-text">${activity.description}</span>
                    `;
                    feed.appendChild(item);
                });

                if (activities.length === 0) {
                    feed.innerHTML = '<div class="activity-item loading">No recent activity</div>';
                }
            }

            updateQueueStatus(queues) {
                const queueList = document.getElementById('queueList');
                queueList.innerHTML = '';

                queues.forEach(queue => {
                    const item = document.createElement('div');
                    item.className = 'queue-item';
                    const badgeClass = this.getServiceBadgeClass(queue.prefix);
                    item.innerHTML = `
                        <span class="service-badge ${badgeClass}">
                            ${queue.prefix} - ${queue.name}
                        </span>
                        <span class="queue-count">${queue.waiting} waiting</span>
                    `;
                    queueList.appendChild(item);
                });

                if (queues.length === 0) {
                    queueList.innerHTML = '<div class="queue-item loading">No active queues</div>';
                }
            }

            updateSystemHealth(health) {
                document.getElementById('dbStatus').className = `health-status ${health.database}`;
                document.getElementById('socketStatus').className = `health-status ${health.socket}`;
                document.getElementById('memoryUsage').textContent = health.memory;
                document.getElementById('uptime').textContent = health.uptime;
            }

            setupDashboardRealtime() {
                // Setup Socket.IO for real-time dashboard updates
                if (typeof io !== 'undefined') {
                    const socket = io('/admin');
                    
                    socket.on('ticket-created', (data) => {
                        this.addActivityItem(data.time, `New ticket ${data.ticket.number} issued (${data.service.name})`);
                        this.updateStatsFromEvent('ticket-created');
                    });

                    socket.on('ticket-called', (data) => {
                        this.addActivityItem(data.time, `Agent ${data.agent.name} called ticket ${data.ticket.number}`);
                    });

                    socket.on('ticket-completed', (data) => {
                        this.addActivityItem(data.time, `Ticket ${data.ticket.number} completed at ${data.counter.name}`);
                        this.updateStatsFromEvent('ticket-completed');
                    });

                    socket.on('queue-updated', (data) => {
                        this.refreshQueueStatus();
                    });
                }

                // Auto-refresh dashboard every 30 seconds
                setInterval(() => {
                    if (this.currentSection === 'dashboard') {
                        this.refreshDashboardStats();
                    }
                }, 30000);
            }

            addActivityItem(time, text) {
                const feed = document.getElementById('activityFeed');
                const item = document.createElement('div');
                item.className = 'activity-item';
                item.innerHTML = `
                    <span class="activity-time">${this.formatTime(new Date(time))}</span>
                    <span class="activity-text">${text}</span>
                `;
                feed.insertBefore(item, feed.firstChild);

                // Keep only last 10 items
                while (feed.children.length > 10) {
                    feed.removeChild(feed.lastChild);
                }
            }

            updateStatsFromEvent(eventType) {
                // Update relevant stats when events occur
                const ticketsElement = document.getElementById('ticketsToday');
                if (eventType === 'ticket-created') {
                    const current = parseInt(ticketsElement.textContent) || 0;
                    ticketsElement.textContent = current + 1;
                }
            }

            async refreshDashboardStats() {
                const stats = await this.loadTodayStats();
                this.updateStatsCards(stats);
            }

            async refreshQueueStatus() {
                const queues = await this.loadQueueStatus();
                this.updateQueueStatus(queues);
            }

            formatTime(date) {
                return date.toLocaleTimeString('en-US', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }

            async loadServicesData() {
                try {
                    console.log('Loading services data...');

                    const services = await this.loadServicesList();
                    this.servicesData = services;
                    this.renderAgentServiceOptions(services);
                    this.populatePresetServiceOptions(services);

                    const statsData = this.computeServicesStats(services);
                    const performanceData = this.computeServicePerformance(services);

                    this.updateServicesTable(services);
                    this.updateServicesStats(statsData);
                    this.updateServicePerformance(performanceData);

                } catch (error) {
                    console.error('Error loading services data:', error);
                    this.showError('Error loading services data. Please try again.');
                }
            }

            async loadServicesList() {
                try {
                    const response = await this.apiCall('/admin/services');
                    if (!response.ok) {
                        throw new Error('Failed to fetch services');
                    }

                    const data = await response.json();
                    const services = Array.isArray(data.services) ? data.services : [];
                    return services.map(service => ({
                        ...service,
                        is_active: service.is_active === true || service.is_active === 1 || service.is_active === 'true'
                    }));
                } catch (error) {
                    console.error('Error loading services list:', error);
                    return [];
                }
            }

            computeServicesStats(services = []) {
                const totalServices = services.length;
                const activeServices = services.filter(s => s.is_active).length;
                const totalTicketsToday = services.reduce((sum, s) => sum + (s.tickets_today || 0), 0);
                const avgServiceTime = services.length
                    ? services.reduce((sum, s) => sum + (s.avg_wait_today || 0), 0) / services.length
                    : 0;

                return {
                    totalServices,
                    activeServices,
                    totalTicketsToday,
                    avgServiceTime: avgServiceTime.toFixed(1)
                };
            }

            computeServicePerformance(services = []) {
                return services.map(service => ({
                    id: service.id,
                    name: service.name,
                    prefix: service.prefix,
                    tickets_today: service.tickets_today || 0,
                    avg_wait: service.avg_wait_today || 0,
                    efficiency: this.calculateEfficiency(service.tickets_today, service.avg_wait_today)
                }));
            }

            renderAgentServiceOptions(services = []) {
                const container = document.getElementById('serviceAssignments');
                if (!container) return;

                if (!Array.isArray(services) || services.length === 0) {
                    container.innerHTML = '<div class="service-assignment">No services available</div>';
                    return;
                }

                container.innerHTML = services
                    .map(service => {
                        const prefix = (service.prefix || '').toString().trim() || '?';
                        const prefixKey = prefix.toUpperCase();
                        const badgeMap = {
                            A: 'general',
                            B: 'account',
                            V: 'vip',
                            T: 'technical'
                        };
                        const badgeClass = badgeMap[prefixKey] || 'general';
                        const serviceName = service.name || `Service ${service.id}`;
                        return `
                            <div class="service-assignment">
                                <label class="service-checkbox">
                                    <input type="checkbox" name="services" value="${service.id}" data-service="${prefix}">
                                    <span class="service-badge ${badgeClass}">${prefix}</span>
                                    <span class="service-name">${serviceName}</span>
                                    <select class="priority-select" name="priority_${service.id}">
                                        <option value="1">Primary</option>
                                        <option value="2">Secondary</option>
                                    </select>
                                </label>
                            </div>
                        `;
                    })
                    .join('');
            }

            calculateEfficiency(tickets, avgWait) {
                if (!tickets || !avgWait) return 100;
                // Simple efficiency calculation: more tickets + less wait = higher efficiency
                const efficiency = Math.max(0, 100 - (avgWait * 5));
                return Math.min(100, efficiency);
            }

            updateServicesTable(services) {
                const tbody = document.getElementById('servicesTableBody');
                tbody.innerHTML = '';

                if (!services || services.length === 0) {
                    tbody.innerHTML = '<tr class="loading-row"><td colspan="8" class="text-center">No services found</td></tr>';
                    return;
                }

                services.forEach(service => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div style="font-weight: 600; color: #1F2937;">${service.name}</div>
                            <div style="font-size: 12px; color: #6B7280;">${service.description || 'No description'}</div>
                        </td>
                        <td>
                            <span class="service-prefix">${service.prefix}</span>
                        </td>
                        <td>${service.range_start} - ${service.range_end}</td>
                        <td>
                            <span style="font-weight: 600;">${service.prefix}${String(service.current_number).padStart(3, '0')}</span>
                        </td>
                        <td>
                            <span class="service-status ${service.is_active ? 'active' : 'inactive'}">
                                ${service.is_active ? '●' : '●'} ${service.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td style="font-weight: 600; color: #10B981;">${service.tickets_today || 0}</td>
                        <td>${service.avg_wait_today ? service.avg_wait_today + 'm' : '--'}</td>
                        <td>
                            <div class="service-actions">
                                <button class="service-action-btn edit" onclick="editService(${service.id})" title="Edit Service">
                                    ✏️
                                </button>
                                <button class="service-action-btn toggle" onclick="toggleService(${service.id})" title="${service.is_active ? 'Deactivate' : 'Activate'} Service">
                                    ${service.is_active ? '⏸️' : '▶️'}
                                </button>
                                <button class="service-action-btn delete" onclick="deleteService(${service.id}, '${service.name}')" title="Delete Service">
                                    🗑️
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                // Store services data for filtering
                this.servicesData = services;
            }

            updateServicesStats(stats) {
                document.getElementById('totalServices').textContent = stats.totalServices;
                document.getElementById('activeServices').textContent = stats.activeServices;
                document.getElementById('totalTicketsToday').textContent = stats.totalTicketsToday;
                document.getElementById('avgServiceTime').textContent = stats.avgServiceTime + 'm';
            }

            updateServicePerformance(performance) {
                const grid = document.getElementById('servicePerformanceGrid');
                grid.innerHTML = '';

                if (!performance || performance.length === 0) {
                    grid.innerHTML = '<div class="performance-loading">No performance data available</div>';
                    return;
                }

                performance.forEach(service => {
                    const item = document.createElement('div');
                    item.className = 'performance-item';
                    item.innerHTML = `
                        <div class="performance-service-name">${service.prefix} - ${service.name}</div>
                        <div style="font-size: 24px; font-weight: 700; color: #10B981; margin: 8px 0;">
                            ${service.tickets_today}
                        </div>
                        <div style="font-size: 12px; color: #6B7280;">tickets today</div>
                        <div class="performance-stats">
                            <span>Avg Wait: ${service.avg_wait}m</span>
                            <span>Efficiency: ${service.efficiency}%</span>
                        </div>
                    `;
                    grid.appendChild(item);
                });
            }

            filterServices() {
                const searchTerm = document.getElementById('servicesSearch').value.toLowerCase();
                const tbody = document.getElementById('servicesTableBody');
                const rows = tbody.querySelectorAll('tr:not(.loading-row)');

                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            }

            showError(message) {
                // Simple error handling - could be enhanced with toast notifications
                console.error(message);
                alert(message);
            }

            showSuccess(message) {
                // Simple success handling - could be enhanced with toast notifications
                console.log(message);
                alert(message);
            }

            validateServiceForm(formData) {
                const errors = [];

                // Required field validation
                if (!formData.serviceName.trim()) {
                    errors.push('Service name is required');
                }

                if (!formData.servicePrefix.trim()) {
                    errors.push('Service prefix is required');
                }

                if (!formData.rangeStart || formData.rangeStart < 1) {
                    errors.push('Range start must be a positive number');
                }

                if (!formData.rangeEnd || formData.rangeEnd < 1) {
                    errors.push('Range end must be a positive number');
                }

                if (formData.rangeStart >= formData.rangeEnd) {
                    errors.push('Range end must be greater than range start');
                }

                // Business logic validation
                if (formData.servicePrefix.length > 3) {
                    errors.push('Service prefix must be 3 characters or less');
                }

                // Check for duplicate prefix (would need to check against existing services)
                const existingPrefixes = this.servicesData?.map(s => s.prefix.toLowerCase()) || [];
                const currentId = formData.serviceId;
                const currentService = this.servicesData?.find(s => s.id == currentId);
                
                if (existingPrefixes.includes(formData.servicePrefix.toLowerCase()) && 
                    (!currentService || currentService.prefix.toLowerCase() !== formData.servicePrefix.toLowerCase())) {
                    errors.push('Service prefix already exists');
                }

                return errors;
            }

            async saveServiceData(serviceData) {
                try {
                    // This would call the actual API
                    // POST /api/admin/services (for new) or PUT /api/admin/services/:id (for edit)
                    
                    const isEdit = serviceData.serviceId;
                    const method = isEdit ? 'PUT' : 'POST';
                    const url = isEdit ? `/admin/services/${serviceData.serviceId}` : '/admin/services';

                    const response = await this.apiCall(url, {
                        method,
                        body: JSON.stringify({
                            name: serviceData.serviceName,
                            prefix: serviceData.servicePrefix,
                            description: serviceData.serviceDescription,
                            range_start: parseInt(serviceData.rangeStart),
                            range_end: parseInt(serviceData.rangeEnd),
                            current_number: parseInt(serviceData.currentNumber) || 0,
                            estimated_service_time: parseInt(serviceData.estimatedServiceTime) || 300,
                            is_active: serviceData.isActive
                        })
                    });

                    if (response.ok) {
                        this.showSuccess(isEdit ? 'Service updated successfully!' : 'Service created successfully!');
                        await this.loadServicesData(); // Refresh the data
                        return true;
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || 'Failed to save service');
                    }
                } catch (error) {
                    console.error('Error saving service:', error);
                    this.showError('Error saving service: ' + error.message);
                    return false;
                }
            }

            async deleteServiceData(serviceId) {
                try {
                    const response = await this.apiCall(`/admin/services/${serviceId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        this.showSuccess('Service deleted successfully!');
                        await this.loadServicesData(); // Refresh the data
                        return true;
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || 'Failed to delete service');
                    }
                } catch (error) {
                    console.error('Error deleting service:', error);
                    this.showError('Error deleting service: ' + error.message);
                    return false;
                }
            }

            async toggleServiceStatus(serviceId) {
                try {
                    const service = this.servicesData?.find(s => s.id === serviceId);
                    if (!service) {
                        throw new Error('Service not found');
                    }

                    const response = await this.apiCall(`/admin/services/${serviceId}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            ...service,
                            is_active: !service.is_active
                        })
                    });

                    if (response.ok) {
                        const action = service.is_active ? 'deactivated' : 'activated';
                        this.showSuccess(`Service ${action} successfully!`);
                        await this.loadServicesData(); // Refresh the data
                        return true;
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || 'Failed to toggle service status');
                    }
                } catch (error) {
                    console.error('Error toggling service status:', error);
                    this.showError('Error updating service status: ' + error.message);
                    return false;
                }
            }

            async loadAgentsData() {
                try {
                    console.log('Loading agents data...');

                    const agents = await this.loadAgentsList();
                    this.agentsData = agents;

                    const statsData = this.computeAgentsStats(agents);
                    const performanceData = this.computeAgentPerformance(agents);
                    const onlineData = this.computeOnlineAgents(agents);

                    this.updateAgentsTable(agents);
                    this.updateAgentsStats(statsData);
                    this.updateAgentPerformance(performanceData);
                    this.updateOnlineAgents(onlineData);

                } catch (error) {
                    console.error('Error loading agents data:', error);
                    this.showError('Error loading agents data. Please try again.');
                }
            }

            async loadAgentsList() {
                try {
                    const response = await this.apiCall('/admin/agents');
                    if (!response.ok) {
                        throw new Error('Failed to fetch agents');
                    }

                    const data = await response.json();
                    const agents = Array.isArray(data.agents) ? data.agents : [];

                    return agents.map(agent => ({
                        ...agent,
                        role: agent.role || 'agent',
                        status: agent.status || 'offline',
                        current_counter: agent.current_counter || null,
                        services: (agent.services || []).map(service => ({
                            service_id: service.service_id,
                            service_name: service.service_name,
                            prefix: service.prefix,
                            priority: service.priority
                        })),
                        performance: agent.performance || {
                            tickets_today: 0,
                            avg_service_time: 0,
                            efficiency: 100
                        }
                    }));
                } catch (error) {
                    console.error('Error loading agents list:', error);
                    return [];
                }
            }

            computeAgentsStats(agents = []) {
                if (!agents.length) {
                    return {
                        totalAgents: 0,
                        onlineAgents: 0,
                        topPerformer: '—',
                        totalTicketsServed: 0
                    };
                }

                const onlineAgents = agents.filter(agent => agent.status === 'online');
                const totalTicketsServed = agents.reduce(
                    (sum, agent) => sum + (agent.performance?.tickets_today || 0),
                    0
                );

                const topPerformerAgent = [...agents]
                    .sort((a, b) => (b.performance?.tickets_today || 0) - (a.performance?.tickets_today || 0))[0];

                return {
                    totalAgents: agents.length,
                    onlineAgents: onlineAgents.length,
                    topPerformer: topPerformerAgent ? topPerformerAgent.name : '—',
                    totalTicketsServed
                };
            }

            computeAgentPerformance(agents = []) {
                return [...agents]
                    .map(agent => ({
                        id: agent.id,
                        name: agent.name,
                        status: agent.status,
                        performance: agent.performance || {
                            tickets_today: 0,
                            avg_service_time: 0,
                            efficiency: 100
                        },
                        services: agent.services || []
                    }))
                    .sort((a, b) => (b.performance.tickets_today || 0) - (a.performance.tickets_today || 0));
            }

            computeOnlineAgents(agents = []) {
                return agents
                    .filter(agent => agent.status === 'online')
                    .map(agent => ({
                        id: agent.id,
                        name: agent.name,
                        current_counter: agent.current_counter,
                        services: agent.services || []
                    }));
            }

            updateAgentsStats(stats = {}) {
                const totals = {
                    totalAgents: document.getElementById('totalAgents'),
                    onlineAgents: document.getElementById('onlineAgents'),
                    topPerformer: document.getElementById('topPerformer'),
                    totalTicketsServed: document.getElementById('totalTicketsServed'),
                    liveOnlineCount: document.getElementById('liveOnlineCount')
                };

                if (totals.totalAgents) {
                    totals.totalAgents.textContent = stats.totalAgents ?? 0;
                }
                if (totals.onlineAgents) {
                    totals.onlineAgents.textContent = stats.onlineAgents ?? 0;
                }
                if (totals.topPerformer) {
                    totals.topPerformer.textContent = stats.topPerformer ?? '—';
                }
                if (totals.totalTicketsServed) {
                    totals.totalTicketsServed.textContent = stats.totalTicketsServed ?? 0;
                }
                if (totals.liveOnlineCount) {
                    const onlineCount = stats.onlineAgents ?? 0;
                    totals.liveOnlineCount.textContent = `${onlineCount} ${onlineCount === 1 ? 'agent' : 'agents'} online`;
                }
            }

            updateOnlineAgents(onlineAgents = []) {
                const grid = document.getElementById('onlineAgentsGrid');
                if (!grid) return;

                grid.innerHTML = '';

                if (onlineAgents.length === 0) {
                    grid.innerHTML = '<div class="online-agent-loading">No agents currently online</div>';
                    return;
                }

                onlineAgents.forEach((agent) => {
                    const initials = agent.name
                        .split(' ')
                        .map((n) => n[0])
                        .join('');
                    const item = document.createElement('div');
                    item.className = 'online-agent-card';
                    item.innerHTML = `
                        <div class="agent-avatar" style="background: ${this.getAgentColor(agent.id)};">
                            ${initials}
                        </div>
                        <div class="agent-info">
                            <div class="agent-name">${agent.name}</div>
                            <div class="agent-status">${agent.current_counter || 'Available'}</div>
                            <div class="agent-services-badges">
                                ${(agent.services || [])
                                    .map(
                                        (service) =>
                                            `<span class="service-badge ${service.prefix?.toLowerCase() || 'general'}">${service.prefix}</span>`
                                    )
                                    .join('')}
                            </div>
                        </div>
                    `;
                    grid.appendChild(item);
                });
            }

            updateAgentsTable(agents) {
                const tbody = document.getElementById('agentsTableBody');
                tbody.innerHTML = '';

                if (!agents || agents.length === 0) {
                    tbody.innerHTML = '<tr class="loading-row"><td colspan="8" class="text-center">No agents found</td></tr>';
                    return;
                }

                agents.forEach(agent => {
                    const initials = agent.name.split(' ').map(n => n[0]).join('');
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="agent-cell">
                                <div class="agent-avatar" style="background: ${this.getAgentColor(agent.id)};">
                                    ${initials}
                                </div>
                                <div class="agent-details">
                                    <div class="agent-name">${agent.name}</div>
                                    <div class="agent-email">${agent.email || 'No email'}</div>
                                </div>
                            </div>
                        </td>
                        <td><code>${agent.username}</code></td>
                        <td>
                            <span class="agent-status-badge ${agent.status}">
                                ${this.getStatusIcon(agent.status)} ${this.capitalizeFirst(agent.status)}
                            </span>
                        </td>
                        <td>
                            <div class="agent-services">
                                ${agent.services.map(s => 
                                    `<span class="service-badge ${s.prefix.toLowerCase()}" title="${s.service_name} (${s.priority === 1 ? 'Primary' : 'Secondary'})">${s.prefix}</span>`
                                ).join('')}
                            </div>
                        </td>
                        <td>
                            ${agent.current_counter ? 
                                `<span class="agent-counter">${agent.current_counter}</span>` : 
                                '<span style="color: #9CA3AF;">Not assigned</span>'
                            }
                        </td>
                        <td>
                            <div class="agent-performance">
                                <span class="performance-number">${agent.performance.tickets_today}</span>
                                <span class="performance-label">tickets</span>
                            </div>
                        </td>
                        <td>
                            <span class="agent-role-badge ${agent.role}">${agent.role}</span>
                        </td>
                        <td>
                            <div class="agent-actions">
                                <button class="agent-action-btn edit" onclick="editAgent(${agent.id})" title="Edit Agent">
                                    ✏️
                                </button>
                                <button class="agent-action-btn reset" onclick="resetAgentPassword(${agent.id})" title="Reset Password">
                                    🔑
                                </button>
                                <button class="agent-action-btn delete" onclick="deleteAgent(${agent.id}, '${agent.name}')" title="Delete Agent">
                                    🗑️
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                // Store agents data for filtering
                this.agentsData = agents;
            }

            updateAgentPerformance(performance) {
                const grid = document.getElementById('agentPerformanceGrid');
                grid.innerHTML = '';

                if (!performance || performance.length === 0) {
                    grid.innerHTML = '<div class="performance-loading">No performance data available</div>';
                    return;
                }

                performance.forEach(agent => {
                    const item = document.createElement('div');
                    item.className = 'agent-performance-item';
                    item.innerHTML = `
                        <div class="performance-agent-name">${agent.name}</div>
                        <div class="performance-metrics">
                            <div class="performance-metric">
                                <span class="performance-metric-value">${agent.performance.tickets_today}</span>
                                <span class="performance-metric-label">Tickets</span>
                            </div>
                            <div class="performance-metric">
                                <span class="performance-metric-value">${agent.performance.avg_service_time}m</span>
                                <span class="performance-metric-label">Avg Time</span>
                            </div>
                            <div class="performance-metric">
                                <span class="performance-metric-value">${agent.performance.efficiency}%</span>
                                <span class="performance-metric-label">Efficiency</span>
                            </div>
                            <div class="performance-metric">
                                <span class="performance-metric-value">${agent.status === 'online' ? '🟢' : '🔴'}</span>
                                <span class="performance-metric-label">Status</span>
                            </div>
                        </div>
                    `;
                    grid.appendChild(item);
                });
            }

            getAgentColor(agentId) {
                const colors = ['#8B5CF6', '#10B981', '#F59E0B', '#3B82F6', '#EF4444'];
                return colors[agentId % colors.length];
            }

            getStatusIcon(status) {
                const icons = {
                    online: '🟢',
                    offline: '🔴',
                    break: '🟡'
                };
                return icons[status] || '⚪';
            }

            capitalizeFirst(str) {
                if (!str) return '';
                return str.charAt(0).toUpperCase() + str.slice(1);
            }

            filterAgents() {
                const searchTerm = document.getElementById('agentsSearch').value.toLowerCase();
                const tbody = document.getElementById('agentsTableBody');
                const rows = tbody.querySelectorAll('tr:not(.loading-row)');

                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            }

            validateAgentForm(formData) {
                const errors = [];

                // Required field validation
                if (!formData.agentName.trim()) {
                    errors.push('Agent name is required');
                }

                if (!formData.agentUsername.trim()) {
                    errors.push('Username is required');
                }

                // Business logic validation
                if (formData.agentUsername.length < 3) {
                    errors.push('Username must be at least 3 characters');
                }

                if (formData.agentEmail && !this.isValidEmail(formData.agentEmail)) {
                    errors.push('Please enter a valid email address');
                }

                // Check for duplicate username
                const existingUsernames = this.agentsData?.map(a => a.username.toLowerCase()) || [];
                const currentId = formData.agentId;
                const currentAgent = this.agentsData?.find(a => a.id == currentId);
                
                if (existingUsernames.includes(formData.agentUsername.toLowerCase()) && 
                    (!currentAgent || currentAgent.username.toLowerCase() !== formData.agentUsername.toLowerCase())) {
                    errors.push('Username already exists');
                }

                // Service assignment validation
                if (!formData.services || formData.services.length === 0) {
                    errors.push('At least one service must be assigned');
                }

                return errors;
            }

            isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            async saveAgentData(agentData) {
                try {
                    const isEdit = agentData.agentId;
                    const method = isEdit ? 'PUT' : 'POST';
                    const url = isEdit ? `/admin/agents/${agentData.agentId}` : '/admin/agents';

                    const response = await this.apiCall(url, {
                        method,
                        body: JSON.stringify({
                            name: agentData.agentName,
                            username: agentData.agentUsername,
                            email: agentData.agentEmail,
                            role: agentData.agentRole,
                            is_active: agentData.agentActive,
                            password: agentData.agentPassword,
                            services: agentData.services
                        })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        const baseMessage = isEdit ? 'Agent updated successfully!' : 'Agent created successfully!';
                        if (result.temporaryPassword) {
                            this.showSuccess(`${baseMessage} Temporary password: ${result.temporaryPassword}`);
                        } else {
                            this.showSuccess(baseMessage);
                        }
                        await this.loadAgentsData();
                        return true;
                    } else {
                        throw new Error(result.error || result.message || 'Failed to save agent');
                    }
                } catch (error) {
                    console.error('Error saving agent:', error);
                    this.showError('Error saving agent: ' + error.message);
                    return false;
                }
            }

            async deleteAgentData(agentId) {
                try {
                    const response = await this.apiCall(`/admin/agents/${agentId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        this.showSuccess('Agent deleted successfully!');
                        await this.loadAgentsData();
                        return true;
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || 'Failed to delete agent');
                    }
                } catch (error) {
                    console.error('Error deleting agent:', error);
                    this.showError('Error deleting agent: ' + error.message);
                    return false;
                }
            }

            async resetAgentPasswordData(agentId) {
                try {
                    const response = await this.apiCall(`/admin/agents/${agentId}/reset-password`, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.showSuccess(`Password reset successfully! New password: ${result.temporaryPassword}`);
                        return true;
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || 'Failed to reset password');
                    }
                } catch (error) {
                    console.error('Error resetting password:', error);
                    this.showError('Error resetting password: ' + error.message);
                    return false;
                }
            }

            async loadSettingsData() {
                try {
                    console.log('Loading settings data...');
                    
                    // Load settings data
                    const settingsData = await this.loadSystemSettings();
                    this.updateSettingsInterface(settingsData);
                    this.updateSettingsStats(settingsData);

                } catch (error) {
                    console.error('Error loading settings data:', error);
                    this.showError('Error loading settings data. Please try again.');
                }
            }

            async loadSystemSettings() {
                return this.loadCurrentSettings();
            }

            async loadCurrentSettings() {
                try {
                    const response = await this.apiCall('/admin/settings');
                    if (!response.ok) {
                        throw new Error('Failed to fetch settings');
                    }

                    const payload = await response.json();
                    const normalized = payload?.normalized || {};
                    const state = this.buildSettingsStateFromNormalized(normalized);
                    if (Array.isArray(payload?.recent_changes)) {
                        state.recent_changes = payload.recent_changes;
                    }
                    return state;
                } catch (error) {
                    console.error('Error loading current settings:', error);
                    return this.getDefaultSettings();
                }
            }

            buildSettingsStateFromNormalized(normalized = {}) {
                const toBool = (value, fallback = false) => {
                    if (value === 'true') return true;
                    if (value === 'false') return false;
                    if (value === '1') return true;
                    if (value === '0') return false;
                    if (typeof value === 'string') {
                        return value.toLowerCase() === 'true';
                    }
                    return value === undefined ? fallback : Boolean(value);
                };

                const toInt = (value, fallback) => {
                    const parsed = parseInt(value, 10);
                    return Number.isNaN(parsed) ? fallback : parsed;
                };

                const rawEnabledLanguages = normalized.enabledLanguages || normalized.enabled_languages;
                let enabledLanguages;
                if (Array.isArray(rawEnabledLanguages)) {
                    enabledLanguages = rawEnabledLanguages;
                } else if (typeof rawEnabledLanguages === 'string') {
                    enabledLanguages = rawEnabledLanguages
                        .split(',')
                        .map((lang) => lang.trim())
                        .filter(Boolean);
                } else {
                    enabledLanguages = ['en'];
                }

                const defaultLanguage = normalized.defaultLanguage || enabledLanguages[0] || 'en';

                return {
                    features: {
                        park_unpark: toBool(normalized.parkEnabled, false),
                        cherry_pick: toBool(normalized.cherryPickEnabled, false),
                        recycle: toBool(normalized.recycleEnabled, false),
                        multi_service: toBool(normalized.multiServiceEnabled, false),
                        voice_announcements: toBool(normalized.voiceEnabled, true),
                        languages: toBool(normalized.languagesEnabled, enabledLanguages.length > 1)
                    },
                    config: {
                        max_recall: toInt(normalized.maxRecalls, 3),
                        auto_complete: toInt(normalized.autoComplete ?? normalized.recallInterval, 30),
                        recycle_position: toInt(normalized.recyclePosition, 3),
                        reset_time: normalized.resetTime || '00:00',
                        daily_reset: toBool(normalized.dailyReset, false),
                        enabled_languages: enabledLanguages
                    },
                    branding: {
                        system_name: normalized.systemName || 'FlowMatic-SOLO',
                        language: defaultLanguage,
                        version: normalized.systemVersion || '2.0.0'
                    },
                    recent_changes: []
                };
            }

            getDefaultSettings() {
                return {
                    features: {
                        park_unpark: false,
                        cherry_pick: false,
                        recycle: true,
                        multi_service: false,
                        voice_announcements: true,
                        languages: true
                    },
                    config: {
                        max_recall: 3,
                        auto_complete: 30,
                        recycle_position: 3,
                        reset_time: '00:00',
                        daily_reset: true,
                        enabled_languages: ['en']
                    },
                    branding: {
                        system_name: 'FlowMatic-SOLO',
                        language: 'en',
                        version: '2.0.0'
                    },
                    recent_changes: []
                };
            }

            updateSettingsInterface(settings) {
                // Update feature flags
                Object.keys(settings.features).forEach(feature => {
                    const checkbox = document.getElementById(`feature_${feature}`);
                    if (checkbox) {
                        checkbox.checked = settings.features[feature];
                    }
                });

                // Update config items
                Object.keys(settings.config).forEach(config => {
                    const input = document.getElementById(`config_${config}`);
                    if (input) {
                        if (input.type === 'checkbox') {
                            input.checked = settings.config[config];
                        } else {
                            input.value = settings.config[config];
                        }
                    }
                });

                // Update branding items
                Object.keys(settings.branding).forEach(item => {
                    const input = document.getElementById(`branding_${item}`);
                    if (input) {
                        input.value = settings.branding[item];
                    }
                });

                // Update language selector
                document.querySelectorAll('.language-option').forEach(option => {
                    option.classList.remove('active');
                });
                const activeLanguage = document.querySelector(`[data-lang="${settings.branding.language}"]`);
                if (activeLanguage) {
                    activeLanguage.classList.add('active');
                }

                // Update recent changes
                this.updateRecentChanges(settings.recent_changes);

                // Store settings data
                this.settingsData = settings;
            }

            updateSettingsStats(settings) {
                // Count enabled features
                const enabledFeatures = Object.values(settings.features).filter(Boolean).length;
                const totalFeatures = Object.keys(settings.features).length;
                
                document.getElementById('enabledFeatures').textContent = enabledFeatures;
                document.getElementById('configItems').textContent = Object.keys(settings.config).length;
                document.getElementById('systemLanguage').textContent = settings.branding.language.toUpperCase();
                document.getElementById('recentChanges').textContent = settings.recent_changes.length;

                // Update trends
                const enabledTrend = document.querySelector('.stat-card .stat-trend');
                if (enabledTrend) {
                    enabledTrend.textContent = `of ${totalFeatures} total`;
                }
            }

            collectSettingsPayload() {
                const boolById = (id, fallback = false) => {
                    const el = document.getElementById(id);
                    return el ? !!el.checked : fallback;
                };

                const numberById = (id, fallback) => {
                    const el = document.getElementById(id);
                    if (!el) return fallback;
                    const parsed = parseInt(el.value, 10);
                    return Number.isNaN(parsed) ? fallback : parsed;
                };

                const valueById = (id, fallback = '') => {
                    const el = document.getElementById(id);
                    return el ? el.value : fallback;
                };

                const activeLanguage = document.querySelector('.language-option.active');
                const defaultLanguage = activeLanguage?.dataset.lang || this.settingsData?.branding?.language || 'en';

                let enabledLanguages = this.settingsData?.config?.enabled_languages;
                if (!enabledLanguages || enabledLanguages.length === 0) {
                    enabledLanguages = [defaultLanguage];
                }

                return {
                    parkEnabled: boolById('feature_park_unpark'),
                    cherryPickEnabled: boolById('feature_cherry_pick'),
                    recycleEnabled: boolById('feature_recycle', true),
                    multiServiceEnabled: boolById('feature_multi_service'),
                    voiceEnabled: boolById('feature_voice', true),
                    languagesEnabled: boolById('feature_languages', true),
                    maxRecalls: numberById('config_max_recall', 3),
                    autoComplete: numberById('config_auto_complete', 30),
                    recyclePosition: numberById('config_recycle_position', 3),
                    resetTime: valueById('config_reset_time', '00:00'),
                    dailyReset: boolById('config_daily_reset', false),
                    defaultLanguage,
                    enabledLanguages
                };
            }

            updateRecentChanges(changes) {
                const container = document.getElementById('recentChanges');
                container.innerHTML = '';

                if (!changes || changes.length === 0) {
                    container.innerHTML = '<div class="change-item loading">No recent changes</div>';
                    return;
                }

                changes.forEach(change => {
                    const item = document.createElement('div');
                    item.className = 'change-item';
                    item.innerHTML = `
                        <span class="change-time">${change.time}</span>
                        <span class="change-text">${change.text}</span>
                        <span class="change-user">${change.user}</span>
                    `;
                    container.appendChild(item);
                });
            }

            handleFeatureToggle(checkbox) {
                const feature = checkbox.dataset.feature;
                const enabled = checkbox.checked;
                
                console.log(`Feature ${feature} ${enabled ? 'enabled' : 'disabled'}`);
                
                // Update settings data
                if (this.settingsData && this.settingsData.features) {
                    this.settingsData.features[feature] = enabled;
                }

                // Add to recent changes
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
                const changeText = `${this.getFeatureName(feature)} ${enabled ? 'enabled' : 'disabled'}`;
                
                this.addRecentChange(timeStr, changeText, 'Admin');
                
                // Update stats
                this.updateSettingsStats(this.settingsData);
            }

            handleConfigChange(input) {
                const configKey = input.id.replace('config_', '');
                const value = input.type === 'checkbox' ? input.checked : input.value;
                
                console.log(`Config ${configKey} changed to ${value}`);
                
                // Update settings data
                if (this.settingsData && this.settingsData.config) {
                    this.settingsData.config[configKey] = value;
                }

                // Add to recent changes
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
                const changeText = `${this.getConfigName(configKey)} changed to ${value}`;
                
                this.addRecentChange(timeStr, changeText, 'Admin');
            }

            handleLanguageChange(option) {
                const language = option.dataset.lang;
                
                // Update UI
                document.querySelectorAll('.language-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                option.classList.add('active');
                
                // Update settings data
                if (this.settingsData && this.settingsData.branding) {
                    this.settingsData.branding.language = language;
                }
                if (this.settingsData && this.settingsData.config) {
                    this.settingsData.config.enabled_languages = [language];
                }
                
                // Update stats
                document.getElementById('systemLanguage').textContent = language.toUpperCase();
                
                // Add to recent changes
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
                const changeText = `System language changed to ${this.getLanguageName(language)}`;
                
                this.addRecentChange(timeStr, changeText, 'Admin');
            }

            addRecentChange(time, text, user) {
                // Add to the beginning of recent changes
                if (this.settingsData && this.settingsData.recent_changes) {
                    this.settingsData.recent_changes.unshift({ time, text, user });
                    
                    // Keep only last 10 changes
                    if (this.settingsData.recent_changes.length > 10) {
                        this.settingsData.recent_changes = this.settingsData.recent_changes.slice(0, 10);
                    }
                    
                    // Update display
                    this.updateRecentChanges(this.settingsData.recent_changes);
                }
            }

            getFeatureName(feature) {
                const names = {
                    park_unpark: 'Park/Unpark Tickets',
                    cherry_pick: 'Cherry Pick Tickets',
                    recycle: 'Recycle Tickets',
                    multi_service: 'Multi-Service Priority',
                    voice_announcements: 'Voice Announcements',
                    languages: 'Multi-Language Support'
                };
                return names[feature] || feature;
            }

            getConfigName(config) {
                const names = {
                    max_recall: 'Max Recall Count',
                    auto_complete: 'Auto-Complete Timeout',
                    recycle_position: 'Recycle Position',
                    reset_time: 'Daily Reset Time',
                    daily_reset: 'Daily Reset'
                };
                return names[config] || config;
            }

            getLanguageName(lang) {
                const names = {
                    en: 'English',
                    th: 'Thai',
                    hi: 'Hindi'
                };
                return names[lang] || lang;
            }

            async saveAllSettings() {
                try {
                    const button = document.querySelector('.action-btn.primary');
                    const originalText = button.textContent;
                    button.disabled = true;
                    button.textContent = 'Saving...';

                    const payload = this.collectSettingsPayload();
                    console.log('[Admin] Saving settings payload:', payload);

                    const response = await this.apiCall('/admin/settings', {
                        method: 'PUT',
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        // Show success message
                        const successMsg = document.getElementById('settingsSuccess');
                        successMsg.classList.add('show');
                        setTimeout(() => {
                            successMsg.classList.remove('show');
                        }, 3000);

                        const now = new Date();
                        const timeStr = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
                        this.addRecentChange(timeStr, 'All settings saved successfully', 'Admin');
                        console.log('Settings saved successfully');
                    } else {
                        throw new Error('Failed to save settings');
                    }
                } catch (error) {
                    console.error('Error saving settings:', error);
                    this.showError('Error saving settings: ' + error.message);
                } finally {
                    const button = document.querySelector('.action-btn.primary');
                    button.disabled = false;
                    button.textContent = 'Save All Changes';
                }
            }

            async exportSettings() {
                try {
                    // Export settings as JSON
                    const settingsJson = JSON.stringify(this.settingsData, null, 2);
                    const blob = new Blob([settingsJson], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `flowmatic-settings-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showSuccess('Settings exported successfully!');
                } catch (error) {
                    console.error('Error exporting settings:', error);
                    this.showError('Error exporting settings: ' + error.message);
                }
            }

            async resetToDefaults() {
                if (confirm('Are you sure you want to reset all settings to default values? This cannot be undone.')) {
                    try {
                        // Reset to default settings
                        const defaultSettings = {
                            features: {
                                park_unpark: false,
                                cherry_pick: false,
                                recycle: false,
                                multi_service: false,
                                voice_announcements: true,
                                languages: true
                            },
                            config: {
                                max_recall: 3,
                                auto_complete: 30,
                                recycle_position: 3,
                                reset_time: '00:00',
                                daily_reset: true
                            },
                            branding: {
                                system_name: 'FlowMatic-SOLO',
                                language: 'en',
                                version: '2.0.0'
                            },
                            recent_changes: []
                        };

                        this.settingsData = defaultSettings;
                        this.updateSettingsInterface(defaultSettings);
                        this.updateSettingsStats(defaultSettings);

                        // Add reset event to changes
                        const now = new Date();
                        const timeStr = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
                        this.addRecentChange(timeStr, 'All settings reset to defaults', 'Admin');

                        this.showSuccess('Settings reset to defaults successfully!');
                    } catch (error) {
                        console.error('Error resetting settings:', error);
                        this.showError('Error resetting settings: ' + error.message);
                    }
                }
            }

            async apiCall(endpoint, options = {}) {
                const config = {
                    headers: {
                        'Authorization': `Bearer ${this.token}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                };

                const response = await fetch(`${this.apiBase}${endpoint}`, config);
                
                if (response.status === 401) {
                    this.handleLogout();
                    throw new Error('Unauthorized');
                }

                return response;
            }
        }

        // Initialize admin panel when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.adminPanel = new AdminPanel();
        });

        // Global functions for services management
        let currentServiceIdToDelete = null;

        async function addService() {
            // Reset form for new service
            document.getElementById('serviceForm').reset();
            document.getElementById('serviceId').value = '';
            document.getElementById('serviceModalTitle').textContent = 'Add New Service';
            document.getElementById('saveButtonText').textContent = 'Create Service';
            document.getElementById('isActive').checked = true;
            
            // Clear validation messages
            const validationDiv = document.getElementById('validationMessages');
            validationDiv.classList.remove('show');
            
            // Show modal
            document.getElementById('serviceModal').classList.add('show');
        }

        async function editService(serviceId) {
            const service = window.adminPanel.servicesData?.find(s => s.id === serviceId);
            if (!service) {
                alert('Service not found');
                return;
            }

            // Populate form with service data
            document.getElementById('serviceId').value = service.id;
            document.getElementById('serviceName').value = service.name;
            document.getElementById('servicePrefix').value = service.prefix;
            document.getElementById('serviceDescription').value = service.description || '';
            document.getElementById('rangeStart').value = service.range_start;
            document.getElementById('rangeEnd').value = service.range_end;
            document.getElementById('currentNumber').value = service.current_number;
            document.getElementById('estimatedServiceTime').value = service.estimated_service_time;
            document.getElementById('isActive').checked = service.is_active;

            // Update modal title
            document.getElementById('serviceModalTitle').textContent = 'Edit Service';
            document.getElementById('saveButtonText').textContent = 'Update Service';
            
            // Clear validation messages
            const validationDiv = document.getElementById('validationMessages');
            validationDiv.classList.remove('show');
            
            // Show modal
            document.getElementById('serviceModal').classList.add('show');
        }

        async function saveService(event) {
            event.preventDefault();
            
            const form = document.getElementById('serviceForm');
            const formData = new FormData(form);
            const serviceData = {
                serviceId: formData.get('serviceId'),
                serviceName: formData.get('serviceName'),
                servicePrefix: formData.get('servicePrefix').toUpperCase(),
                serviceDescription: formData.get('serviceDescription'),
                rangeStart: formData.get('rangeStart'),
                rangeEnd: formData.get('rangeEnd'),
                currentNumber: formData.get('currentNumber'),
                estimatedServiceTime: formData.get('estimatedServiceTime'),
                isActive: formData.get('isActive') === 'on'
            };

            // Validate form
            const errors = window.adminPanel.validateServiceForm(serviceData);
            if (errors.length > 0) {
                const validationDiv = document.getElementById('validationMessages');
                validationDiv.innerHTML = errors.map(error => `• ${error}`).join('<br>');
                validationDiv.classList.add('show');
                return;
            }

            // Hide validation messages
            document.getElementById('validationMessages').classList.remove('show');

            // Disable submit button
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            try {
                const success = await window.adminPanel.saveServiceData(serviceData);
                if (success) {
                    closeServiceModal();
                }
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        function closeServiceModal() {
            document.getElementById('serviceModal').classList.remove('show');
        }

        async function deleteService(serviceId, serviceName) {
            currentServiceIdToDelete = serviceId;
            document.getElementById('deleteServiceName').textContent = serviceName;
            document.getElementById('deleteConfirmModal').classList.add('show');
        }

        function closeDeleteModal() {
            document.getElementById('deleteConfirmModal').classList.remove('show');
            currentServiceIdToDelete = null;
        }

        async function confirmDeleteService() {
            if (!currentServiceIdToDelete) return;

            const success = await window.adminPanel.deleteServiceData(currentServiceIdToDelete);
            if (success) {
                closeDeleteModal();
            }
        }

        async function toggleService(serviceId) {
            if (confirm('Are you sure you want to change the status of this service?')) {
                await window.adminPanel.toggleServiceStatus(serviceId);
            }
        }

        function filterServices() {
            if (window.adminPanel) {
                window.adminPanel.filterServices();
            }
        }

        async function refreshServiceStats() {
            if (window.adminPanel && window.adminPanel.currentSection === 'services') {
                await window.adminPanel.loadServicesData();
                
                // Visual feedback
                const btn = event.target;
                btn.style.transform = 'rotate(360deg)';
                setTimeout(() => {
                    btn.style.transform = 'rotate(0deg)';
                }, 500);
            }
        }

        // Global functions for agents management
        let currentAgentIdToDelete = null;

        async function addAgent() {
            // Reset form for new agent
            document.getElementById('agentForm').reset();
            document.getElementById('agentId').value = '';
            document.getElementById('agentModalTitle').textContent = 'Add New Agent';
            document.getElementById('agentSaveButtonText').textContent = 'Create Agent';
            document.getElementById('agentActive').checked = true;
            
            // Reset service assignments
            document.querySelectorAll('input[name="services"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('.priority-select').forEach(select => {
                select.value = '1';
            });
            
            // Clear validation messages
            const validationDiv = document.getElementById('agentValidationMessages');
            validationDiv.classList.remove('show');
            
            // Show modal
            document.getElementById('agentModal').classList.add('show');
        }

        async function editAgent(agentId) {
            const agent = window.adminPanel.agentsData?.find(a => a.id === agentId);
            if (!agent) {
                alert('Agent not found');
                return;
            }

            // Populate form with agent data
            document.getElementById('agentId').value = agent.id;
            document.getElementById('agentName').value = agent.name;
            document.getElementById('agentUsername').value = agent.username;
            document.getElementById('agentEmail').value = agent.email || '';
            document.getElementById('agentRole').value = agent.role;
            document.getElementById('agentActive').checked = agent.is_active;
            document.getElementById('agentPassword').value = ''; // Always empty for security

            // Set service assignments
            document.querySelectorAll('input[name="services"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('.priority-select').forEach(select => {
                select.value = '1';
            });
            
            agent.services.forEach(service => {
                const checkbox = document.querySelector(`input[name="services"][value="${service.service_id}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                    const prioritySelect = document.querySelector(`select[name="priority_${service.service_id}"]`);
                    if (prioritySelect) {
                        prioritySelect.value = service.priority;
                    }
                }
            });

            // Update modal title
            document.getElementById('agentModalTitle').textContent = 'Edit Agent';
            document.getElementById('agentSaveButtonText').textContent = 'Update Agent';
            
            // Clear validation messages
            const validationDiv = document.getElementById('agentValidationMessages');
            validationDiv.classList.remove('show');
            
            // Show modal
            document.getElementById('agentModal').classList.add('show');
        }

        async function saveAgent(event) {
            event.preventDefault();
            
            const form = document.getElementById('agentForm');
            const formData = new FormData(form);
            
            // Collect service assignments
            const services = [];
            document.querySelectorAll('input[name="services"]:checked').forEach(checkbox => {
                const serviceId = checkbox.value;
                const prioritySelect = document.querySelector(`select[name="priority_${serviceId}"]`);
                services.push({
                    service_id: parseInt(serviceId),
                    priority: parseInt(prioritySelect.value)
                });
            });

            const agentData = {
                agentId: formData.get('agentId'),
                agentName: formData.get('agentName'),
                agentUsername: formData.get('agentUsername').toLowerCase(),
                agentEmail: formData.get('agentEmail'),
                agentRole: formData.get('agentRole'),
                agentPassword: formData.get('agentPassword'),
                agentActive: formData.get('agentActive') === 'on',
                services: services
            };

            // Validate form
            const errors = window.adminPanel.validateAgentForm(agentData);
            if (errors.length > 0) {
                const validationDiv = document.getElementById('agentValidationMessages');
                validationDiv.innerHTML = errors.map(error => `• ${error}`).join('<br>');
                validationDiv.classList.add('show');
                return;
            }

            // Hide validation messages
            document.getElementById('agentValidationMessages').classList.remove('show');

            // Disable submit button
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            try {
                const success = await window.adminPanel.saveAgentData(agentData);
                if (success) {
                    closeAgentModal();
                }
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        function closeAgentModal() {
            document.getElementById('agentModal').classList.remove('show');
        }

        async function deleteAgent(agentId, agentName) {
            currentAgentIdToDelete = agentId;
            document.getElementById('deleteAgentName').textContent = agentName;
            document.getElementById('deleteAgentModal').classList.add('show');
        }

       function closeDeleteAgentModal() {
           document.getElementById('deleteAgentModal').classList.remove('show');
           currentAgentIdToDelete = null;
       }

        function closeResetScheduleModal() {
            if (window.adminPanel && typeof window.adminPanel.closeResetScheduleModal === 'function') {
                window.adminPanel.closeResetScheduleModal();
            } else {
                document.getElementById('resetScheduleModal').classList.remove('show');
            }
        }

        async function confirmDeleteAgent() {
            if (!currentAgentIdToDelete) return;

            const success = await window.adminPanel.deleteAgentData(currentAgentIdToDelete);
            if (success) {
                closeDeleteAgentModal();
            }
        }

        async function resetAgentPassword(agentId) {
            if (confirm('Are you sure you want to reset this agent\'s password? A new temporary password will be generated.')) {
                await window.adminPanel.resetAgentPasswordData(agentId);
            }
        }

        function filterAgents() {
            if (window.adminPanel) {
                window.adminPanel.filterAgents();
            }
        }

        async function refreshAgentStats() {
            if (window.adminPanel && window.adminPanel.currentSection === 'agents') {
                await window.adminPanel.loadAgentsData();
                
                // Visual feedback
                const btn = event.target;
                btn.style.transform = 'rotate(360deg)';
                setTimeout(() => {
                    btn.style.transform = 'rotate(0deg)';
                }, 500);
            }
        }

        // Global functions for settings management
        async function refreshSettings() {
            if (window.adminPanel && window.adminPanel.currentSection === 'settings') {
                await window.adminPanel.loadSettingsData();
                
                // Visual feedback
                const btn = event.target;
                btn.style.transform = 'rotate(360deg)';
                setTimeout(() => {
                    btn.style.transform = 'rotate(0deg)';
                }, 500);
            }
        }

        async function refreshChanges() {
            if (window.adminPanel && window.adminPanel.currentSection === 'settings') {
                // Refresh recent changes
                const settings = await window.adminPanel.loadCurrentSettings();
                window.adminPanel.updateRecentChanges(settings.recent_changes);
                
                // Visual feedback
                const btn = event.target;
                btn.style.transform = 'rotate(360deg)';
                setTimeout(() => {
                    btn.style.transform = 'rotate(0deg)';
                }, 500);
            }
        }

        async function saveAllSettings() {
            if (window.adminPanel) {
                await window.adminPanel.saveAllSettings();
            }
        }

        async function exportSettings() {
            if (window.adminPanel) {
                await window.adminPanel.exportSettings();
            }
        }

        async function resetToDefaults() {
            if (window.adminPanel) {
                await window.adminPanel.resetToDefaults();
            }
        }

        // Handle service checkbox change to show/hide priority select
        document.addEventListener('change', function(event) {
            if (event.target.name === 'services') {
                const serviceId = event.target.value;
                const prioritySelect = document.querySelector(`select[name="priority_${serviceId}"]`);
                if (prioritySelect) {
                    prioritySelect.style.display = event.target.checked ? 'block' : 'none';
                }
            }
        });

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const serviceModal = document.getElementById('serviceModal');
            const deleteModal = document.getElementById('deleteConfirmModal');
            const agentModal = document.getElementById('agentModal');
            const deleteAgentModal = document.getElementById('deleteAgentModal');
            const resetScheduleModal = document.getElementById('resetScheduleModal');
            
            if (event.target === serviceModal) {
                closeServiceModal();
            }
            
            if (event.target === deleteModal) {
                closeDeleteModal();
            }
            
            if (event.target === agentModal) {
                closeAgentModal();
            }
            
            if (event.target === deleteAgentModal) {
                closeDeleteAgentModal();
            }

            if (event.target === resetScheduleModal) {
                closeResetScheduleModal();
            }
        });

        // Update escape key handler for all modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeServiceModal();
                closeDeleteModal();
                closeAgentModal();
                closeDeleteAgentModal();
                closeResetScheduleModal();
            }
        });

        // Global functions for dashboard quick actions
        async function resetQueue() {
            if (window.adminPanel) {
                await window.adminPanel.confirmManualReset();
            }
        }

        async function addAgentFromDashboard() {
            // Quick navigation to agents section
            window.adminPanel.showSection('agents');
        }

        async function toggleFeature() {
            // Quick navigation to settings section
            window.adminPanel.showSection('settings');
        }

        async function systemHealth() {
            try {
                const health = await window.adminPanel.loadSystemHealth();
                const healthStatus = Object.entries(health).map(([key, value]) => 
                    `${key}: ${value}`
                ).join('\n');
                
                alert(`System Health Status:\n\n${healthStatus}`);
            } catch (error) {
                console.error('Health check error:', error);
                alert('Error checking system health.');
            }
        }

        async function refreshQueues() {
            if (window.adminPanel) {
                await window.adminPanel.refreshQueueStatus();
                
                // Visual feedback
                const btn = event.target;
                btn.style.transform = 'rotate(360deg)';
                setTimeout(() => {
                    btn.style.transform = 'rotate(0deg)';
                }, 500);
            }
        }
    </script>
</body>
</html>
